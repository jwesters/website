<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Which Song Is Older?</title>
  <style>
    :root{
      --bg:#0b0f17;
      --text:#e8eefc;
      --muted:#a9b6d6;
      --accent:#7aa2ff;
      --good:#46d17d;
      --bad:#ff5b6e;
      --border:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% -10%, rgba(122,162,255,.25), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(70,209,125,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:18px;
    }
    .wrap{width:min(980px, 100%); display:flex; flex-direction:column; gap:14px;}
    header{
      display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    header .left{display:flex; flex-direction:column; gap:2px}
    h1{font-size:18px; margin:0; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:13px}
    .pillrow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--border);
      padding:7px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.12);
      display:flex; gap:8px; align-items:center;
      user-select:none;
    }
    .pill b{color:var(--text); font-weight:650}
    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:rgba(122,162,255,.14);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
      letter-spacing:.2px;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{background:rgba(122,162,255,.20); border-color:rgba(255,255,255,.18)}
    .btn:active{transform: translateY(1px)}
    .btn.danger{background:rgba(255,91,110,.14)}
    .btn.danger:hover{background:rgba(255,91,110,.20)}

    .main{
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 860px){ .main{grid-template-columns:1fr;} }

    .panel{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.025));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      background:rgba(0,0,0,.12);
    }
    .panel .hd .t{font-weight:750}
    .panel .bd{padding:14px;}

    .status{margin-top:10px; font-size:13px; color:var(--muted)}
    .status.good{color:rgba(70,209,125,.95)}
    .status.bad{color:rgba(255,91,110,.95)}

    .choices{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:10px;
    }
    @media (max-width: 560px){ .choices{grid-template-columns:1fr;} }

    .choice{
      border:1px solid var(--border);
      border-radius: 18px;
      padding:16px;
      background: linear-gradient(180deg, rgba(17,26,42,.95), rgba(15,22,38,.92));
      cursor:pointer;
      text-align:left;
      transition: transform .06s ease, border-color .12s ease, background .12s ease;
      min-height:120px;
      display:flex;
      flex-direction:column;
      gap:10px;
      position:relative;
      overflow:hidden;
    }
    .choice:hover{border-color:rgba(255,255,255,.18); background: linear-gradient(180deg, rgba(20,32,54,.98), rgba(15,22,38,.92));}
    .choice:active{transform: translateY(1px)}
    .choice .title{font-size:16px; font-weight:800; line-height:1.25; color:var(--text);}
    .choice .meta{font-size:12px; color:var(--muted); display:none}
    .choice[disabled]{opacity:.55; cursor:not-allowed}

    .reveal{
      margin-top:12px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.14);
      color:var(--muted);
      font-size:13px;
      display:none;
      line-height:1.4;
    }
    .reveal.show{display:block}
    .reveal .ok{color:rgba(70,209,125,.95); font-weight:800}
    .reveal .no{color:rgba(255,91,110,.95); font-weight:800}

    .list{display:flex; flex-direction:column; gap:8px; margin-top:10px;}
    .rowItem{
      display:flex; justify-content:space-between; gap:10px;
      border:1px solid var(--border);
      border-radius: 14px;
      padding:10px 12px;
      background: rgba(0,0,0,.12);
      font-size:13px;
      color:var(--muted);
    }
    .rowItem b{color:var(--text)}
    .small{font-size:12px; color:var(--muted)}
    .foot{display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:center; margin-top:10px;}

    .toast{
      position:fixed;
      bottom:16px;
      left:50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.16);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      max-width:min(92vw, 720px);
      box-shadow: var(--shadow);
      display:none;
    }
    .toast.show{display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="left">
        <h1>Which song is older?</h1>
        <div class="sub">Pick the song which reached #1 on the Billboard 100 first. One wrong answer ends the run.</div>
      </div>
      <div class="pillrow">
        <div class="pill">Round: <b id="roundNum">0</b></div>
        <div class="pill">Correct: <b id="scoreNum">0</b></div>
        <button class="btn" id="btnRestart" title="Restart the run (score resets)">Restart</button>
      </div>
    </header>

    <div class="main">
      <section class="panel">
        <div class="hd">
          <div class="t"> </div>
        </div>
        <div class="bd">
          <div class="status" id="loadStatus">Loadingâ€¦</div>

          <div class="choices" id="choicesArea">
            <button class="choice" id="btnA" disabled>
              <div class="title" id="textA">â€”</div>
              <div class="meta" id="metaA">â€”</div>
            </button>
            <button class="choice" id="btnB" disabled>
              <div class="title" id="textB">â€”</div>
              <div class="meta" id="metaB">â€”</div>
            </button>
          </div>

          <div class="reveal" id="revealBox"></div>

          <div class="foot">
            <div class="small" id="hintLine"></div>
            <div class="pillrow">
              <button class="btn danger" id="btnResetScores" title="Clear stored high scores">Reset High Scores</button>
            </div>
          </div>
        </div>
      </section>

      <aside class="panel">
        <div class="hd">
          <div class="t">Top 5 High Scores</div>
          <div class="small">Stored on this device</div>
        </div>
        <div class="bd">
          <div id="hsEmpty" class="small">No scores yet. Get one wrong to record your run ðŸ™‚</div>
          <div class="list" id="hsList"></div>
          <div class="small" style="margin-top:10px; line-height:1.4;">
            Scores are saved with your <b>local</b> date and time.
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  'use strict';

  // IMPORTANT: Put hot-100-current.csv in the SAME FOLDER as this HTML when you host it.
  const CSV_URL = './hot-100-current.csv';
  const HS_KEY = 'olderSongGame.highScores.v1';
  const TOP_N = 5;
  const CORRECT_MS = 1300; // "Correct" shows twice as long as before

  // DOM
  const loadStatus = document.getElementById('loadStatus');
  const btnA = document.getElementById('btnA');
  const btnB = document.getElementById('btnB');
  const textA = document.getElementById('textA');
  const textB = document.getElementById('textB');
  const metaA = document.getElementById('metaA');
  const metaB = document.getElementById('metaB');
  const revealBox = document.getElementById('revealBox');
  const hintLine = document.getElementById('hintLine');
  const roundNum = document.getElementById('roundNum');
  const scoreNum = document.getElementById('scoreNum');
  const btnRestart = document.getElementById('btnRestart');
  const btnResetScores = document.getElementById('btnResetScores');
  const hsEmpty = document.getElementById('hsEmpty');
  const hsList = document.getElementById('hsList');
  const toast = document.getElementById('toast');

  // State
  let songs = [];
  let curA = null, curB = null;
  let round = 0, score = 0;
  let inPlay = false;
  let locked = false;

  // ---------- Helpers ----------
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toast.classList.remove('show'), 1400);
  }

  function setStatus(msg, cls){
    loadStatus.textContent = msg;
    loadStatus.className = 'status' + (cls ? ' ' + cls : '');
  }

  function enableChoices(enabled){
    btnA.disabled = !enabled;
    btnB.disabled = !enabled;
  }

  function setHUD(){
    roundNum.textContent = String(round);
    scoreNum.textContent = String(score);
  }

  function parseDateStrict(s){
    // Expect YYYY-MM-DD
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(s).trim());
    if(!m) return null;
    const y = +m[1], mo = +m[2]-1, d = +m[3];
    const dt = new Date(y, mo, d);
    if(dt.getFullYear() !== y || dt.getMonth() !== mo || dt.getDate() !== d) return null;
    return dt;
  }

  function detectDelimiter(text){
    const firstLine = text.split(/\r?\n/)[0] || '';
    const commas = (firstLine.match(/,/g)||[]).length;
    const semis  = (firstLine.match(/;/g)||[]).length;
    const tabs   = (firstLine.match(/\t/g)||[]).length;
    if(tabs > commas && tabs > semis) return '\t';
    if(semis > commas) return ';';
    return ',';
  }

  function splitLine(line, delim){
    if(delim === '\t') return line.split('\t');
    const out = [];
    let cur = '';
    let inQ = false;
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(ch === '"'){
        if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
        else inQ = !inQ;
      } else if(ch === delim && !inQ){
        out.push(cur); cur = '';
      } else {
        cur += ch;
      }
    }
    out.push(cur);
    return out;
  }

  function parseCSV(text){
    const delim = detectDelimiter(text);
    const lines = text.split(/\r?\n/).filter(l => l.trim().length);
    if(lines.length < 2) throw new Error('CSV has no data rows.');

    const header = splitLine(lines[0], delim).map(h => h.trim());
    const idx = {
      chart_week: header.findIndex(h => h.toLowerCase() === 'chart_week'),
      title: header.findIndex(h => h.toLowerCase() === 'title'),
      performer: header.findIndex(h => h.toLowerCase() === 'performer')
    };
    if(idx.chart_week < 0 || idx.title < 0 || idx.performer < 0){
      throw new Error('Missing required headers.');
    }

    const rows = [];
    for(let i=1;i<lines.length;i++){
      const parts = splitLine(lines[i], delim);
      const dateStr = (parts[idx.chart_week] ?? '').trim();
      const dt = parseDateStrict(dateStr);
      if(!dt) continue;
      const title = (parts[idx.title] ?? '').trim();
      const performer = (parts[idx.performer] ?? '').trim();
      if(!title || !performer) continue;
      rows.push({ date: dt, dateStr, title, performer });
    }
    return rows;
  }

  function fmtSong(s){ return `${s.performer} â€“ ${s.title}`; }

  function pickTwo(){
    if(songs.length < 2) return null;
    let a, b, tries = 0;
    do{
      a = songs[Math.floor(Math.random() * songs.length)];
      b = songs[Math.floor(Math.random() * songs.length)];
      tries++;
    } while((a === b || a.date.getTime() === b.date.getTime()) && tries < 1000);
    if(a === b || a.date.getTime() === b.date.getTime()) return null;
    return [a,b];
  }

  function showPair(a,b){
    curA = a; curB = b;
    textA.textContent = fmtSong(a);
    textB.textContent = fmtSong(b);
    metaA.textContent = '';
    metaB.textContent = '';
  }

  function restart(){
    revealBox.classList.remove('show');
    revealBox.textContent = '';
    hintLine.textContent = '';
    round = 0; score = 0;
    inPlay = true;
    locked = false;
    setHUD();
    enableChoices(false);
    newRound();
  }

  function newRound(){
    if(locked) return;
    const pair = pickTwo();
    if(!pair){
      setStatus('Not enough usable rows in CSV.', 'bad');
      inPlay = false;
      return;
    }
    round++;
    setHUD();
    showPair(pair[0], pair[1]);
    revealBox.classList.remove('show');
    revealBox.textContent = '';
    enableChoices(true);
    setStatus('', '');
  }

  function updateHighScores(finalScore){
    const now = new Date();
    const entry = {
      score: finalScore,
      when: now.toISOString(),
      local: now.toLocaleString()
    };
    let list = [];
    try{ list = JSON.parse(localStorage.getItem(HS_KEY) || '[]'); }catch(e){ list = []; }
    list.push(entry);
    list.sort((a,b) => b.score - a.score || (a.when < b.when ? 1 : -1));
    list = list.slice(0, TOP_N);
    localStorage.setItem(HS_KEY, JSON.stringify(list));
    renderHighScores();
  }

  function renderHighScores(){
    let list = [];
    try{ list = JSON.parse(localStorage.getItem(HS_KEY) || '[]'); }catch(e){ list = []; }
    hsList.innerHTML = '';
    if(!list.length){
      hsEmpty.style.display = 'block';
      return;
    }
    hsEmpty.style.display = 'none';
    for(const item of list){
      const div = document.createElement('div');
      div.className = 'rowItem';
      div.innerHTML = `<div><b>${item.score}</b> correct</div><div>${item.local}</div>`;
      hsList.appendChild(div);
    }
  }

  function resetHighScores(){
    localStorage.removeItem(HS_KEY);
    renderHighScores();
    showToast('High scores cleared');
  }

  function handleChoice(which){
    if(!inPlay || locked) return;
    locked = true;
    enableChoices(false);

    const a = curA, b = curB;
    const older = (a.date.getTime() < b.date.getTime()) ? 'A' : 'B';
    const ok = (which === older);

    if(ok){
      score++;
      setHUD();
      revealBox.innerHTML = `<span class="ok">Correct</span>`;
      revealBox.classList.add('show');
      setTimeout(() => {
        locked = false;
        newRound();
      }, CORRECT_MS);
    } else {
      inPlay = false;
      const aLine = `${fmtSong(a)} â€” ${a.dateStr}`;
      const bLine = `${fmtSong(b)} â€” ${b.dateStr}`;
      revealBox.innerHTML = `<span class="no">Game over</span><br><br>${aLine}<br>${bLine}`;
      revealBox.classList.add('show');
      hintLine.textContent = `Final score: ${score}.`;
      updateHighScores(score);
      showToast('Saved to high scores (if Top 5)');
      locked = false;
    }
  }

  // Events
  btnA.addEventListener('click', () => handleChoice('A'));
  btnB.addEventListener('click', () => handleChoice('B'));
  btnRestart.addEventListener('click', () => restart());
  btnResetScores.addEventListener('click', resetHighScores);

  // Init
  renderHighScores();
  setHUD();

  async function loadCSV(){
    try{
      const res = await fetch(CSV_URL, { cache: 'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      songs = parseCSV(text);
      if(songs.length < 2) throw new Error('Not enough valid rows (need at least 2).');
      setStatus('', '');
      restart();
    } catch(err) {
      songs = [];
      enableChoices(false);
      inPlay = false;
      setStatus(`Couldn't load hot-100-current.csv. Make sure it's beside the HTML when hosted. (${
        String(err.message || err)
      })`, 'bad');
    }
  }

  loadCSV();
})();
</script>
</body>
</html>
