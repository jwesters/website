<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mass Compare (2x–3x spacing)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 20px; background: #f6f7fb; }
    .wrap { max-width: 980px; margin: 0 auto; }
    .card { background: white; border-radius: 14px; padding: 18px; box-shadow: 0 6px 18px rgba(0,0,0,.08); }
    .row { display:flex; gap: 14px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 280px; }
    h1 { margin: 0 0 10px; font-size: 24px; }
    h2 { margin: 0 0 10px; font-size: 18px; }
    p { margin: 8px 0; }
    button { cursor:pointer; border: none; border-radius: 12px; padding: 14px 14px; font-size: 18px; background: #1f6feb; color: white; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .choiceBtn { width: 100%; text-align: left; background: #111827; }
    .choiceBtn:hover { filter: brightness(1.08); }
    .choiceBtn:disabled:hover { filter: none; }
    .muted { color:#6b7280; }
    .ok { color:#16a34a; font-weight: 700; }
    .bad { color:#dc2626; font-weight: 700; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; background:#eef2ff; color:#3730a3; font-weight:600; font-size: 13px; }
    .small { font-size: 13px; }
    .grid { display:grid; gap: 10px; }
    .controls { display:flex; gap: 10px; flex-wrap: wrap; align-items:center; }
    input[type="file"] { padding: 8px; background: #fff; border-radius: 10px; border: 1px solid #e5e7eb; }
    select { padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; font-size: 14px; }
    .stats { display:flex; gap: 10px; flex-wrap: wrap; }
    .stat { background:#f3f4f6; padding: 10px 12px; border-radius: 12px; }
    code { background:#f3f4f6; padding: 2px 6px; border-radius: 6px; }
    .warn { background:#fff7ed; border: 1px solid #fed7aa; padding: 10px 12px; border-radius: 12px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Mass Compare <span class="pill">2×–3× spacing</span></h1>
    <p class="muted">
      Load a CSV with columns <code>item</code> and <code>weight_kg</code> (optional <code>weight_lbs</code>).
      Each question picks 3 items whose weights are far apart (2×–3× between adjacent choices).
    </p>

    <div class="row">
      <div class="col">
        <h2>1) Load your items CSV</h2>
        <div class="controls">
          <input id="fileInput" type="file" accept=".csv" />
          <button id="useDemoBtn" type="button">Use Demo List</button>
        </div>
        <p class="small muted">Tip: your file like <code>common_items_optionA_450.csv</code> works.</p>
        <div id="loadMsg" class="warn small" style="display:none;"></div>
      </div>

      <div class="col">
        <h2>2) Game options</h2>
        <div class="controls">
          <label class="small muted">Ask for:</label>
          <select id="modeSelect">
            <option value="heaviest" selected>Heaviest</option>
            <option value="lightest">Lightest</option>
          </select>

          <label class="small muted">Show weights after guess:</label>
          <select id="revealSelect">
            <option value="yes" selected>Yes</option>
            <option value="no">No</option>
          </select>
        </div>

        <div class="stats" style="margin-top: 10px;">
          <div class="stat"><div class="small muted">Loaded items</div><div id="countStat">0</div></div>
          <div class="stat"><div class="small muted">Score</div><div id="scoreStat">0</div></div>
          <div class="stat"><div class="small muted">Streak</div><div id="streakStat">0</div></div>
        </div>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid #e5e7eb; margin: 16px 0;">

    <div class="row">
      <div class="col">
        <h2 id="prompt">Load a CSV to start</h2>
        <div id="choices" class="grid"></div>
        <p id="feedback" style="margin-top: 10px;"></p>

        <div class="controls" style="margin-top: 12px;">
          <button id="nextBtn" type="button" disabled>Next</button>
          <button id="resetBtn" type="button" disabled style="background:#6b7280;">Reset Score</button>
        </div>

        <p class="small muted" style="margin-top: 10px;">
          Pluralization: adds <code>s</code> to the last word (no special cases).
        </p>
      </div>

      <div class="col">
        <h2>Spacing rules</h2>
        <p class="small">
          For the 3 items (sorted by weight):<br>
          <code>2.0 ≤ w2/w1 ≤ 3.0</code> and <code>2.0 ≤ w3/w2 ≤ 3.0</code><br>
          So the biggest is <code>4×–9×</code> heavier than the smallest.
        </p>
        <p class="small muted">
          If your dataset doesn’t have enough “spread” to find triples, you’ll get a warning.
          In that case: add more items, or broaden the ratio range in the code.
        </p>
      </div>
    </div>
  </div>
</div>

<script>
/* ------------------------------
   Utilities
--------------------------------- */

// Simple CSV parser (handles quoted commas reasonably)
function parseCSV(text) {
  const rows = [];
  let row = [], cur = "", inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const next = text[i + 1];

    if (ch === '"' && inQuotes && next === '"') { // escaped quote
      cur += '"'; i++;
    } else if (ch === '"') {
      inQuotes = !inQuotes;
    } else if (ch === ',' && !inQuotes) {
      row.push(cur); cur = "";
    } else if ((ch === '\n' || ch === '\r') && !inQuotes) {
      if (ch === '\r' && next === '\n') i++;
      row.push(cur); cur = "";
      if (row.length > 1 || row.some(v => v.trim() !== "")) rows.push(row);
      row = [];
    } else {
      cur += ch;
    }
  }
  row.push(cur);
  if (row.length > 1 || row.some(v => v.trim() !== "")) rows.push(row);
  return rows;
}

// Pluralize by adding "s" to the last word. (No special cases, as requested)
function pluralizeSimple(phrase) {
  const parts = phrase.trim().split(/\s+/);
  if (parts.length === 0) return phrase;
  const last = parts[parts.length - 1];
  if (last.endsWith("s")) return phrase; // already plural-ish
  parts[parts.length - 1] = last + "s";
  return parts.join(" ");
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function fmtKg(x) {
  if (!Number.isFinite(x)) return "?";
  // Show compactly
  if (x >= 1000) return x.toFixed(0) + " kg";
  if (x >= 100) return x.toFixed(1) + " kg";
  if (x >= 10) return x.toFixed(2) + " kg";
  return x.toFixed(3) + " kg";
}

/* ------------------------------
   Game state
--------------------------------- */

let ITEMS = []; // {name, kg}
let score = 0;
let streak = 0;
let currentRound = null; // {choices:[...], correctIndex:int}

const fileInput = document.getElementById("fileInput");
const useDemoBtn = document.getElementById("useDemoBtn");
const nextBtn = document.getElementById("nextBtn");
const resetBtn = document.getElementById("resetBtn");
const modeSelect = document.getElementById("modeSelect");
const revealSelect = document.getElementById("revealSelect");
const choicesDiv = document.getElementById("choices");
const feedbackP = document.getElementById("feedback");
const promptH2 = document.getElementById("prompt");
const countStat = document.getElementById("countStat");
const scoreStat = document.getElementById("scoreStat");
const streakStat = document.getElementById("streakStat");
const loadMsg = document.getElementById("loadMsg");

function setLoadMsg(msg) {
  if (!msg) { loadMsg.style.display = "none"; loadMsg.textContent = ""; return; }
  loadMsg.style.display = "block";
  loadMsg.textContent = msg;
}

function updateStats() {
  countStat.textContent = String(ITEMS.length);
  scoreStat.textContent = String(score);
  streakStat.textContent = String(streak);
}

function resetScore() {
  score = 0;
  streak = 0;
  updateStats();
  feedbackP.textContent = "";
}

/* ------------------------------
   Loading
--------------------------------- */

function loadFromCSVText(text) {
  const rows = parseCSV(text);
  if (rows.length < 2) throw new Error("CSV looks empty.");

  const header = rows[0].map(h => h.trim().toLowerCase());
  const itemIdx = header.indexOf("item");
  const kgIdx = header.indexOf("weight_kg");

  if (itemIdx === -1 || kgIdx === -1) {
    throw new Error("CSV must have headers: item, weight_kg");
  }

  const parsed = [];
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    const name = (r[itemIdx] ?? "").trim();
    const kg = Number((r[kgIdx] ?? "").trim());
    if (!name) continue;
    if (!Number.isFinite(kg) || kg <= 0) continue;
    parsed.push({ name, kg });
  }

  // Ensure uniqueness by name (keep first)
  const seen = new Set();
  const uniq = [];
  for (const it of parsed) {
    const key = it.name.toLowerCase();
    if (seen.has(key)) continue;
    seen.add(key);
    uniq.push(it);
  }

  if (uniq.length < 30) {
    throw new Error("Not enough valid rows parsed. Need at least ~30.");
  }

  // Sort by weight (helps fast search)
  uniq.sort((a,b) => a.kg - b.kg);
  return uniq;
}

fileInput.addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  try {
    const text = await file.text();
    ITEMS = loadFromCSVText(text);
    setLoadMsg(`Loaded ${ITEMS.length} items.`);
    updateStats();
    resetBtn.disabled = false;
    startRound();
  } catch (err) {
    ITEMS = [];
    updateStats();
    resetBtn.disabled = true;
    promptH2.textContent = "Load a CSV to start";
    choicesDiv.innerHTML = "";
    feedbackP.textContent = "";
    setLoadMsg("Error: " + (err?.message ?? String(err)));
  }
});

useDemoBtn.addEventListener("click", () => {
  // Tiny demo with wide spread; you’ll normally load your CSV instead.
  ITEMS = [
    {name:"paper clip", kg:0.001},
    {name:"apple", kg:0.2},
    {name:"cat", kg:4},
    {name:"dog", kg:20},
    {name:"cow", kg:600},
    {name:"pickup truck", kg:2500},
    {name:"cargo ship", kg:50000},
  ].sort((a,b)=>a.kg-b.kg);
  setLoadMsg(`Loaded demo (${ITEMS.length} items).`);
  score = 0; streak = 0;
  updateStats();
  resetBtn.disabled = false;
  startRound();
});

/* ------------------------------
   Round generation with 2x–3x spacing
--------------------------------- */

// Find indices j,k such that 2<=w[j]/w[i]<=3 and 2<=w[k]/w[j]<=3
// We'll attempt multiple random bases. ITEMS is sorted by kg ascending.
function pickTriple() {
  if (ITEMS.length < 30) return null;

  const tries = 4000;
  for (let t = 0; t < tries; t++) {
    const i = Math.floor(Math.random() * (ITEMS.length - 2));
    const w1 = ITEMS[i].kg;

    // find candidates for mid: weights in [2w1, 3w1]
    const min2 = 2 * w1;
    const max2 = 3 * w1;

    // binary search range for mid
    let lo = i + 1, hi = ITEMS.length - 1;
    while (lo < hi) {
      const mid = (lo + hi) >> 1;
      if (ITEMS[mid].kg < min2) lo = mid + 1;
      else hi = mid;
    }
    const startJ = lo;

    lo = i + 1; hi = ITEMS.length - 1;
    while (lo < hi) {
      const mid = ((lo + hi + 1) >> 1);
      if (ITEMS[mid].kg <= max2) lo = mid;
      else hi = mid - 1;
    }
    const endJ = lo;

    if (startJ > endJ || startJ >= ITEMS.length) continue;

    const j = startJ + Math.floor(Math.random() * (endJ - startJ + 1));
    const w2 = ITEMS[j].kg;

    // now choose k in [2w2, 3w2]
    const min3 = 2 * w2;
    const max3 = 3 * w2;

    lo = j + 1; hi = ITEMS.length - 1;
    while (lo < hi) {
      const mid = (lo + hi) >> 1;
      if (ITEMS[mid].kg < min3) lo = mid + 1;
      else hi = mid;
    }
    const startK = lo;

    lo = j + 1; hi = ITEMS.length - 1;
    while (lo < hi) {
      const mid = ((lo + hi + 1) >> 1);
      if (ITEMS[mid].kg <= max3) lo = mid;
      else hi = mid - 1;
    }
    const endK = lo;

    if (startK > endK || startK >= ITEMS.length) continue;

    const k = startK + Math.floor(Math.random() * (endK - startK + 1));

    // Ensure names are distinct (they should be, but just in case)
    const a = ITEMS[i], b = ITEMS[j], c = ITEMS[k];
    const names = new Set([a.name.toLowerCase(), b.name.toLowerCase(), c.name.toLowerCase()]);
    if (names.size !== 3) continue;

    return [a,b,c]; // already in ascending weight
  }
  return null;
}

function startRound() {
  feedbackP.textContent = "";
  nextBtn.disabled = true;

  const triple = pickTriple();
  if (!triple) {
    promptH2.textContent = "Couldn’t find a 2×–3× triple";
    choicesDiv.innerHTML = "";
    setLoadMsg("Warning: Your dataset may not have enough spread to form triples with the strict 2×–3× rule. Add more items or broaden the ratio in the code.");
    return;
  } else {
    setLoadMsg(""); // clear warning
  }

  // Decide correct based on mode
  const mode = modeSelect.value; // heaviest/lightest
  const ascending = triple; // [light, mid, heavy]
  const correctObj = (mode === "heaviest") ? ascending[2] : ascending[0];

  // shuffle display order
  const display = shuffle([...ascending]);
  const correctIndex = display.findIndex(x => x === correctObj);

  currentRound = { choices: display, correctIndex, revealed: false };

  promptH2.textContent = (mode === "heaviest")
    ? "Which is heaviest?"
    : "Which is lightest?";

  renderChoices(false);
}

function renderChoices(disableAll) {
  choicesDiv.innerHTML = "";
  const reveal = (revealSelect.value === "yes");

  currentRound.choices.forEach((obj, idx) => {
    const btn = document.createElement("button");
    btn.className = "choiceBtn";
    btn.disabled = disableAll;
    btn.type = "button";

    // pluralize for display
    const label = pluralizeSimple(obj.name);

    btn.textContent = label;

    btn.addEventListener("click", () => onChoose(idx), { once: true });
    choicesDiv.appendChild(btn);
  });
}

function onChoose(idx) {
  // lock buttons
  Array.from(choicesDiv.querySelectorAll("button")).forEach(b => b.disabled = true);

  const correct = (idx === currentRound.correctIndex);
  if (correct) {
    score += 1;
    streak += 1;
    feedbackP.innerHTML = `<span class="ok">Correct!</span>`;
  } else {
    streak = 0;
    feedbackP.innerHTML = `<span class="bad">Not quite.</span>`;
  }

  // Reveal weights if enabled
  if (revealSelect.value === "yes") {
    const mode = modeSelect.value;
    const choices = currentRound.choices;

    // sort for explanation
    const sorted = [...choices].sort((a,b)=>a.kg-b.kg);
    const w1=sorted[0].kg, w2=sorted[1].kg, w3=sorted[2].kg;
    const r21=(w2/w1), r32=(w3/w2);

    const lines = choices.map((c, i) => {
      const mark = (i === currentRound.correctIndex) ? "✅" : "•";
      return `${mark} ${pluralizeSimple(c.name)} — ${fmtKg(c.kg)}`;
    });

    feedbackP.innerHTML += `<div class="small muted" style="margin-top:8px; white-space:pre-line;">${lines.join("\n")}</div>`;
    feedbackP.innerHTML += `<div class="small muted" style="margin-top:8px;">Ratios (sorted): w2/w1 = ${r21.toFixed(2)}×, w3/w2 = ${r32.toFixed(2)}×</div>`;
  }

  updateStats();
  nextBtn.disabled = false;
}

nextBtn.addEventListener("click", startRound);
resetBtn.addEventListener("click", () => {
  resetScore();
  if (ITEMS.length) startRound();
});

// If user changes mode, just start a new round (if loaded)
modeSelect.addEventListener("change", () => {
  if (ITEMS.length) startRound();
});

revealSelect.addEventListener("change", () => {
  // no-op; affects only future reveals
});

// initial stats
updateStats();
</script>
</body>
</html>
