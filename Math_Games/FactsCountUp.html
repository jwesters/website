<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Math Facts Race</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,0.08);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.65);
      --bad:#ff5c5c;
      --good:#3be37b;
      --line:rgba(255,255,255,0.14);
      --shadow:0 16px 50px rgba(0,0,0,0.35);
      --radius:18px;
      --white:#ffffff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(80,140,255,0.25), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(255,110,180,0.20), transparent 55%),
        radial-gradient(800px 600px at 40% 90%, rgba(60,255,180,0.12), transparent 55%),
        var(--bg);
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:20px;
    }
    .wrap{width:min(920px,100%);display:grid;gap:14px;}
    header{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      padding:10px 6px;
      flex-wrap:wrap;
    }
    h1{margin:0;font-size:clamp(20px,2.6vw,30px);letter-spacing:.2px;}
    .subtitle{margin:0;color:var(--muted);font-size:14px;}
    .panel{
      background:var(--card);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      overflow:hidden;
    }
    .panelInner{padding:18px;}
    .chip{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      background:rgba(0,0,0,0.18);
      white-space:nowrap;
    }
    .kbd{
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      font-size:12px;
      padding:2px 6px;
      border:1px solid var(--line);
      border-radius:8px;
      background:rgba(0,0,0,0.18);
      color:rgba(255,255,255,0.86);
      margin-left:6px;
    }

    /* Operation buttons */
    .menuGrid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:12px;
      margin-top:14px;
    }
    @media (max-width:520px){ .menuGrid{grid-template-columns:1fr;} }

    button{
      appearance:none;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.06);
      color:var(--text);
      border-radius:14px;
      padding:14px 14px;
      font-weight:650;
      font-size:16px;
      cursor:pointer;
      transition:transform .06s ease, background .15s ease, border-color .15s ease;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height:54px;
    }
    button:hover{background:rgba(255,255,255,0.10);border-color:rgba(255,255,255,0.22);}
    button:active{transform:scale(.99);}
    button.secondary{
      background:rgba(255,255,255,0.04);
      font-weight:700;
      font-size:14px;
      padding:12px 14px;
      min-height:46px;
      justify-content:center;
    }
    .hidden{display:none !important;}

    .rules{
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      margin-top:6px;
    }

    /* Main options block */
    .optionsBlock{
      display:grid;
      gap:10px;
      margin-top:10px;
      padding:12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(0,0,0,0.16);
    }
    .qTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .label{
      font-weight:900;
      font-size:14px;
      color:rgba(255,255,255,0.9);
    }
    .qButtons{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .qBtn{
      min-width:64px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.06);
      color:var(--text);
      font-size:16px;
      font-weight:900;
      cursor:pointer;
      transition:transform .06s ease, background .15s ease, border-color .15s ease;
    }
    .qBtn:hover{background:rgba(255,255,255,0.10);border-color:rgba(255,255,255,0.22);}
    .qBtn:active{transform:scale(.99);}
    .qBtn.active{
      background:var(--white);
      color:#000000;
      border-color:var(--white);
    }

    .ynRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      padding-top:2px;
    }
    .ynLabel{
      font-weight:850;
      font-size:13px;
      color:rgba(255,255,255,0.86);
    }
    .ynGroup{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .ynBtn{
      min-width:72px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.06);
      color:var(--text);
      font-size:14px;
      font-weight:900;
      cursor:pointer;
      transition:transform .06s ease, background .15s ease, border-color .15s ease;
    }
    .ynBtn:hover{background:rgba(255,255,255,0.10);border-color:rgba(255,255,255,0.22);}
    .ynBtn:active{transform:scale(.99);}
    .ynBtn.active{
      background:var(--white);
      color:#000000;
      border-color:var(--white);
    }

    /* Space between operation grid and teacher options */
    .teacherSpacer{height:18px;}

    /* Teacher options dropdown (more readable) */
    details.teacher{
      border:1px solid rgba(255,255,255,0.22);
      border-radius:16px;
      background:rgba(255,255,255,0.06);
      overflow:hidden;
    }
    details.teacher[open]{
      background:rgba(255,255,255,0.07);
    }
    details.teacher > summary{
      list-style:none;
      cursor:pointer;
      padding:14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-weight:900;
      user-select:none;
    }
    details.teacher > summary::-webkit-details-marker{ display:none; }

    .teacherBody{
      padding:14px;
      border-top:1px solid rgba(255,255,255,0.18);
      display:grid;
      gap:12px;
    }
    .teacherGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width:720px){ .teacherGrid{grid-template-columns:1fr;} }

    .field{
      display:grid;
      gap:6px;
    }
    .field label{
      font-weight:900;
      font-size:13px;
      color:rgba(255,255,255,0.92);
    }

    /* Teacher dropdown styling: high contrast + big text */
    .teacher select{
      appearance:none;
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(0,0,0,0.50);
      color:rgba(255,255,255,0.98);
      border-radius:12px;
      padding:12px 12px;
      font-weight:900;
      font-size:15px;
      outline:none;
      cursor:pointer;
    }
    .teacher select:focus{
      border-color:rgba(255,255,255,0.55);
      box-shadow:0 0 0 3px rgba(255,255,255,0.10);
    }
    /* Ensure options are readable when the dropdown opens */
    .teacher select option{
      background:#10182b;
      color:#ffffff;
    }

    .linkRow{
      display:flex;
      gap:10px;
      align-items:stretch;
      flex-wrap:wrap;
    }
    .linkRow input{
      flex:1 1 360px;
      min-width:260px;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.22);
      background:rgba(0,0,0,0.38);
      color:rgba(255,255,255,0.96);
      font-size:13px;
      font-weight:800;
      outline:none;
    }
    .tinyNote{
      color:rgba(255,255,255,0.70);
      font-size:12px;
      line-height:1.35;
    }

    /* Game */
    .gameArea{display:grid;gap:12px;}
    .prompt{
      border:1px solid var(--line);
      border-radius:16px;
      padding:18px;
      background:rgba(255,255,255,0.06);
      display:grid;
      gap:10px;
    }
    .modeTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .question{
      font-size:clamp(32px,5vw,54px);
      font-weight:900;
      letter-spacing:.4px;
      text-align:center;
      padding:6px 0 2px;
      font-variant-numeric:tabular-nums;
    }
    .answerRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
    }
    input[type="text"]{
      width:min(240px,100%);
      padding:14px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,0.22);
      color:var(--text);
      font-size:18px;
      outline:none;
      text-align:center;
      font-weight:900;
      font-variant-numeric:tabular-nums;
    }
    input[type="text"]::placeholder{color:rgba(255,255,255,0.35);}
    .msg{min-height:20px;text-align:center;font-size:14px;color:var(--muted);}
    .msg.good{color:var(--good);font-weight:900;}
    .msg.bad{color:var(--bad);font-weight:900;}

    .footerBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:6px;
    }

    /* Review */
    .reviewPanel{
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      background:rgba(0,0,0,0.14);
      display:grid;
      gap:10px;
      margin-top:10px;
    }
    .reviewTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      font-weight:900;
      font-size:16px;
    }
    .reviewSummary{
      color:rgba(255,255,255,0.86);
      line-height:1.35;
      font-size:14px;
    }
    .wrongList{display:grid;gap:8px;}
    .wrongItem{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:rgba(255,255,255,0.05);
      display:grid;
      gap:6px;
    }
    .wrongQ{font-weight:900;font-size:16px;}
    .wrongMeta{color:var(--muted);font-size:13px;line-height:1.35;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Math Facts Race</h1>
        <p class="subtitle">Pick a mode ‚Üí answer correctly ‚Üí see your time.</p>
      </div>
      <div class="chip">Press <span class="kbd">Enter</span> to submit</div>
    </header>

    <div class="panel">
      <div class="panelInner">

        <!-- MENU -->
        <section id="menuScreen">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
            <div>
              <div style="font-weight:900; font-size:18px; margin-bottom:6px;">Pick an operation</div>
              <div class="rules">
                <div><strong>Addition:</strong> 0+0 to 9+9</div>
                <div><strong>Subtraction:</strong> subtract by 0‚Äì9; if subtracting by 6‚Äì9, minuend may be up to 15; no negatives</div>
                <div><strong>Multiplication:</strong> 0√ó0 to 10√ó10</div>
                <div><strong>Division:</strong> related multiplication facts; no √∑0; no remainders</div>
              </div>

              <!-- Main options -->
              <div class="optionsBlock" aria-label="Game options">
                <div class="qTop">
                  <div class="label">Questions per game</div>
                  <div class="qButtons" role="group" aria-label="Choose number of questions">
                    <button class="qBtn active" type="button" data-count="10">10</button>
                    <button class="qBtn" type="button" data-count="20">20</button>
                    <button class="qBtn" type="button" data-count="25">25</button>
                    <button class="qBtn" type="button" data-count="50">50</button>
                  </div>
                </div>

                <div class="ynRow" aria-label="Advance on wrong option">
                  <div class="ynLabel">Advance on wrong?</div>
                  <div class="ynGroup" role="group" aria-label="Advance on wrong yes or no">
                    <button class="ynBtn active" type="button" data-adv="no">No</button>
                    <button class="ynBtn" type="button" data-adv="yes">Yes</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Operation buttons FIRST -->
          <div class="menuGrid">
            <button type="button" data-mode="add"><span>Addition (+)</span><span class="chip">0‚Äì9 facts</span></button>
            <button type="button" data-mode="sub"><span>Subtraction (‚àí)</span><span class="chip">0‚Äì9, up to 15</span></button>
            <button type="button" data-mode="mul"><span>Multiplication (√ó)</span><span class="chip">0‚Äì10 facts</span></button>
            <button type="button" data-mode="div"><span>Division (√∑)</span><span class="chip">no remainders</span></button>
          </div>

          <div class="teacherSpacer"></div>

          <!-- Teacher Options BELOW operations -->
          <details class="teacher" id="teacherDetails">
            <summary>
              <span>Teacher Options</span>
              <span class="chip">Create a share link</span>
            </summary>

            <div class="teacherBody">
              <div class="teacherGrid">
                <div class="field">
                  <label for="tMode">Mode (optional)</label>
                  <select id="tMode">
                    <option value="">(Don‚Äôt force a mode)</option>
                    <option value="add">Addition</option>
                    <option value="sub">Subtraction</option>
                    <option value="mul">Multiplication</option>
                    <option value="div">Division</option>
                  </select>
                </div>

                <div class="field">
                  <label for="tCount">Questions</label>
                  <select id="tCount">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                  </select>
                </div>

                <div class="field">
                  <label for="tAdvance">Advance on wrong</label>
                  <select id="tAdvance">
                    <option value="no">No</option>
                    <option value="yes">Yes</option>
                  </select>
                </div>

                <div class="field">
                  <label for="tStart">Auto-start</label>
                  <select id="tStart">
                    <option value="0">No (student clicks the mode)</option>
                    <option value="1">Yes (start immediately if mode is set)</option>
                  </select>
                </div>
              </div>

              <div class="linkRow">
                <input id="shareLink" type="text" readonly value="" aria-label="Generated share link" />
                <button id="copyLinkBtn" type="button" class="secondary">Copy</button>
              </div>
              <div class="tinyNote" id="copyStatus"></div>
              <div class="tinyNote">Tip: For auto-start links, pick a Mode and set Auto-start to ‚ÄúYes‚Äù.</div>
            </div>
          </details>
        </section>

        <!-- GAME -->
        <section id="gameScreen" class="hidden gameArea">
          <div class="prompt">
            <div class="modeTitle">
              <div style="font-weight:900; font-size:16px;">
                Mode: <span id="modeName">Addition</span>
              </div>
              <div class="chip" id="miniRule"></div>
            </div>

            <div class="question" id="questionText">0 + 0 = ?</div>

            <div class="answerRow">
              <input
                id="answerInput"
                type="text"
                inputmode="numeric"
                autocomplete="off"
                placeholder="Type answer"
                aria-label="Answer"
                pattern="[0-9]*"
              />
              <button id="submitBtn" type="button" style="min-width:140px;">Submit</button>
            </div>

            <div class="msg" id="message"></div>

            <div class="footerBtns">
              <button id="backBtn" type="button" class="secondary">Back to menu</button>
              <button id="restartBtn" type="button" class="secondary">Restart this mode</button>
            </div>
          </div>
        </section>

        <!-- RESULTS -->
        <section id="resultScreen" class="hidden">
          <div class="prompt">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
              <div style="font-weight:900; font-size:18px;">Finished!</div>
              <div class="chip" id="resultModeChip">Mode: Addition</div>
            </div>

            <div class="question" id="finalTime">0.00s</div>
            <div class="msg good" id="resultMsg">Nice work.</div>

            <div class="footerBtns">
              <button id="reviewBtn" type="button">Show wrong questions</button>
              <button id="againBtn" type="button">Play again (same mode)</button>
              <button id="menuBtn" type="button" class="secondary">Back to menu</button>
            </div>

            <div id="reviewPanel" class="reviewPanel hidden" aria-live="polite">
              <div class="reviewTitle">
                <span>Wrong Questions</span>
                <span class="chip" id="wrongCountChip">0 wrong</span>
              </div>
              <div class="reviewSummary" id="patternSummary"></div>
              <div class="wrongList" id="wrongList"></div>
            </div>
          </div>
        </section>

      </div>
    </div>
  </div>

<script>
(() => {
  // ---------- DOM ----------
  const menuScreen = document.getElementById("menuScreen");
  const gameScreen = document.getElementById("gameScreen");
  const resultScreen = document.getElementById("resultScreen");

  const modeNameEl = document.getElementById("modeName");
  const miniRuleEl = document.getElementById("miniRule");
  const questionTextEl = document.getElementById("questionText");

  const answerInput = document.getElementById("answerInput");
  const submitBtn = document.getElementById("submitBtn");
  const messageEl = document.getElementById("message");

  const backBtn = document.getElementById("backBtn");
  const restartBtn = document.getElementById("restartBtn");
  const againBtn = document.getElementById("againBtn");
  const menuBtn = document.getElementById("menuBtn");

  const finalTimeEl = document.getElementById("finalTime");
  const resultModeChip = document.getElementById("resultModeChip");
  const resultMsg = document.getElementById("resultMsg");

  const reviewBtn = document.getElementById("reviewBtn");
  const reviewPanel = document.getElementById("reviewPanel");
  const wrongCountChip = document.getElementById("wrongCountChip");
  const patternSummary = document.getElementById("patternSummary");
  const wrongList = document.getElementById("wrongList");

  // Main menu option buttons
  const qBtns = Array.from(document.querySelectorAll(".qBtn"));
  const advBtns = Array.from(document.querySelectorAll(".ynBtn"));

  // Teacher Options elements
  const tMode = document.getElementById("tMode");
  const tCount = document.getElementById("tCount");
  const tAdvance = document.getElementById("tAdvance");
  const tStart = document.getElementById("tStart");
  const shareLink = document.getElementById("shareLink");
  const copyLinkBtn = document.getElementById("copyLinkBtn");
  const copyStatus = document.getElementById("copyStatus");

  // ---------- UTIL ----------
  const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

  function formatSeconds(ms) {
    const s = ms / 1000;
    return `${s.toFixed(2)}s`;
  }

  function show(el){ el.classList.remove("hidden"); }
  function hide(el){ el.classList.add("hidden"); }

  function setMessage(text, kind=""){
    messageEl.textContent = text || "";
    messageEl.classList.remove("good","bad");
    if(kind) messageEl.classList.add(kind);
  }

  function stripNonDigits(s){
    return (s || "").replace(/\D+/g, "");
  }

  function buildUrl(params){
    const url = new URL(window.location.href);
    url.search = "";
    for (const [k,v] of Object.entries(params)){
      if (v === "" || v === null || v === undefined) continue;
      url.searchParams.set(k, String(v));
    }
    return url.toString();
  }

  function parseQuery(){
    const p = new URLSearchParams(window.location.search);
    return {
      mode: p.get("mode") || "",
      count: p.get("count") || "",
      advance: p.get("advance") || "",
      start: p.get("start") || ""
    };
  }

  // ---------- GAME STATE ----------
  const MODE_INFO = {
    add: { name: "Addition (+)", rule: "0+0 to 9+9" },
    sub: { name: "Subtraction (‚àí)", rule: "Subtract by 0‚Äì9; if subtracting by 6‚Äì9, minuend may be up to 15; no negatives" },
    mul: { name: "Multiplication (√ó)", rule: "0√ó0 to 10√ó10" },
    div: { name: "Division (√∑)", rule: "Related facts; no √∑0; no remainders" }
  };

  let mode = null;
  let TOTAL = 10;
  let advanceOnWrong = false; // default "No"

  let startMs = 0;
  let timerRunning = false;

  let runLog = [];
  let current = null;
  let qIndex = 0;

  function resetRun(){
    startMs = 0;
    timerRunning = false;
    runLog = [];
    current = null;
    qIndex = 0;

    setMessage("");
    answerInput.value = "";

    hide(reviewPanel);
    reviewBtn.textContent = "Show wrong questions";
    wrongList.innerHTML = "";
    patternSummary.textContent = "";
  }

  function startTimerIfNeeded(){
    if(!timerRunning){
      startMs = performance.now();
      timerRunning = true;
    }
  }

  function elapsedMs(){
    if(!timerRunning) return 0;
    return Math.max(0, performance.now() - startMs);
  }

  function makeQuestionForMode(m){
    if(m === "add"){
      const a = randInt(0,9);
      const b = randInt(0,9);
      return { mode:m, a, b, op:"+", correctAnswer:a+b, text:`${a} + ${b} = ?` };
    }
    if(m === "sub"){
      const b = randInt(0,9);
      const maxMinuend = (b >= 6) ? 15 : 9;
      const a = randInt(b, maxMinuend);
      return { mode:m, a, b, op:"‚àí", correctAnswer:a-b, text:`${a} ‚àí ${b} = ?` };
    }
    if(m === "mul"){
      const a = randInt(0,10);
      const b = randInt(0,10);
      return { mode:m, a, b, op:"√ó", correctAnswer:a*b, text:`${a} √ó ${b} = ?` };
    }
    const divisor = randInt(1,10);
    const quotient = randInt(0,10);
    const dividend = divisor * quotient;
    return { mode:m, a:dividend, b:divisor, op:"√∑", correctAnswer:quotient, text:`${dividend} √∑ ${divisor} = ?` };
  }

  function loadNextQuestion(){
    startTimerIfNeeded();
    current = makeQuestionForMode(mode);
    questionTextEl.textContent = current.text;

    runLog.push({
      mode: current.mode,
      a: current.a,
      b: current.b,
      op: current.op,
      text: current.text,
      correctAnswer: current.correctAnswer,
      attempts: [],
      endedAsCorrect: false,
      finalAnswer: null
    });

    qIndex = runLog.length - 1;

    answerInput.value = "";
    answerInput.focus({preventScroll:true});
    setMessage("");
  }

  function finishRun(){
    const t = elapsedMs();
    hide(gameScreen);
    show(resultScreen);

    finalTimeEl.textContent = formatSeconds(t);
    resultModeChip.textContent = `Mode: ${MODE_INFO[mode].name}`;
    resultMsg.textContent = `You finished ${TOTAL} questions in ${formatSeconds(t)}.`;

    renderReview();
    hide(reviewPanel);
    reviewBtn.textContent = "Show wrong questions";
  }

  // Digits-only input
  answerInput.addEventListener("keydown", (e) => {
    const allowedKeys = ["Backspace","Delete","ArrowLeft","ArrowRight","Home","End","Tab","Enter"];
    if (allowedKeys.includes(e.key)) return;
    if (e.ctrlKey || e.metaKey) return;
    if (/^\d$/.test(e.key)) return;
    e.preventDefault();
  });

  answerInput.addEventListener("input", () => {
    const clean = stripNonDigits(answerInput.value);
    if (answerInput.value !== clean) answerInput.value = clean;
  });

  answerInput.addEventListener("paste", (e) => {
    e.preventDefault();
    const text = (e.clipboardData || window.clipboardData).getData("text");
    const clean = stripNonDigits(text);
    document.execCommand("insertText", false, clean);
  });

  function parseWholeNumber(){
    const s = stripNonDigits(answerInput.value).trim();
    if (s === "") return null;
    return Number(s);
  }

  function submit(){
    if(!current) return;

    const val = parseWholeNumber();
    if(val === null){
      setMessage("Type a number.", "bad");
      return;
    }

    const entry = runLog[qIndex];
    entry.attempts.push(val);

    const isCorrect = (val === entry.correctAnswer);

    if(isCorrect){
      entry.endedAsCorrect = true;
      entry.finalAnswer = val;
      setMessage("Correct!", "good");

      if(runLog.length >= TOTAL) setTimeout(finishRun, 160);
      else setTimeout(loadNextQuestion, 160);
      return;
    }

    entry.finalAnswer = val;
    setMessage("Try again.", "bad");

    if(advanceOnWrong){
      if(runLog.length >= TOTAL) setTimeout(finishRun, 160);
      else setTimeout(loadNextQuestion, 160);
    }else{
      answerInput.select();
      answerInput.focus({preventScroll:true});
    }
  }

  submitBtn.addEventListener("click", submit);
  answerInput.addEventListener("keydown", (e) => { if(e.key === "Enter") submit(); });

  // Review/pattern
  function getWrongEntries(){
    return runLog.filter(q => {
      if(!q.endedAsCorrect) return true;
      return q.attempts.some(a => a !== q.correctAnswer);
    });
  }

  function analyzePattern(wrongs){
    if(wrongs.length === 0) return "No wrong questions this round.";

    const buckets = new Map();
    const bump = (label) => buckets.set(label, (buckets.get(label) || 0) + 1);

    for(const q of wrongs){
      if(q.mode === "add"){
        bump(`Addition: +${q.a}`);
        bump(`Addition: +${q.b}`);
      }else if(q.mode === "sub"){
        bump(`Subtraction: ‚àí${q.b}`);
        if(q.b >= 6) bump(`Subtraction: high subtract (6‚Äì9)`);
        if(q.a >= 12) bump(`Subtraction: minuend 12‚Äì15`);
      }else if(q.mode === "mul"){
        bump(`Multiplication: √ó${q.a}`);
        bump(`Multiplication: √ó${q.b}`);
      }else if(q.mode === "div"){
        bump(`Division: √∑${q.b}`);
      }
    }

    let topLabel = null, topCount = 0;
    for(const [label,count] of buckets.entries()){
      if(count > topCount){ topCount = count; topLabel = label; }
    }

    const ratio = topCount / wrongs.length;
    if(topLabel && topCount >= 2 && ratio >= 0.40){
      return `Likely pattern: <strong>${topLabel}</strong> (shows up ${topCount} of ${wrongs.length} wrong questions).`;
    }

    const top3 = Array.from(buckets.entries()).sort((a,b) => b[1]-a[1]).slice(0,3);
    const parts = top3.map(([label,count]) => `${label} (${count})`);
    return `No single strong pattern, but the most common trouble spots were: <strong>${parts.join(", ")}</strong>.`;
  }

  function renderReview(){
    const wrongs = getWrongEntries();
    wrongCountChip.textContent = `${wrongs.length} wrong`;
    patternSummary.innerHTML = analyzePattern(wrongs);

    wrongList.innerHTML = "";
    if(wrongs.length === 0){
      const div = document.createElement("div");
      div.className = "wrongItem";
      div.innerHTML = `<div class="wrongQ">Perfect round üéâ</div><div class="wrongMeta">You didn't miss any questions.</div>`;
      wrongList.appendChild(div);
      return;
    }

    for(const q of wrongs){
      const attemptsStr = q.attempts.length ? q.attempts.join(", ") : "‚Äî";
      const final = (q.finalAnswer === null) ? "‚Äî" : String(q.finalAnswer);
      const correctness = q.endedAsCorrect ? "Eventually correct" : "Not correct";

      const safeTitle = q.text.replace("= ?", "").trim().replace(/</g,"&lt;").replace(/>/g,"&gt;");
      const meta = `Your attempts: ${attemptsStr}\nFinal answer entered: ${final}\nCorrect answer: ${q.correctAnswer}\nResult: ${correctness}`
        .replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/\n/g,"<br>");

      const item = document.createElement("div");
      item.className = "wrongItem";
      item.innerHTML = `<div class="wrongQ">${safeTitle}</div><div class="wrongMeta">${meta}</div>`;
      wrongList.appendChild(item);
    }
  }

  reviewBtn.addEventListener("click", () => {
    const showing = !reviewPanel.classList.contains("hidden");
    if(showing){
      hide(reviewPanel);
      reviewBtn.textContent = "Show wrong questions";
    }else{
      renderReview();
      show(reviewPanel);
      reviewBtn.textContent = "Hide wrong questions";
    }
  });

  // Main menu state setters
  function setMainCount(count){
    const allowed = new Set([10,20,25,50]);
    const c = allowed.has(Number(count)) ? Number(count) : 10;
    TOTAL = c;
    qBtns.forEach(b => b.classList.toggle("active", Number(b.dataset.count) === c));
  }

  function setMainAdvance(advYes){
    advanceOnWrong = !!advYes;
    advBtns.forEach(b => b.classList.toggle("active",
      (b.dataset.adv === "yes") === advanceOnWrong
    ));
  }

  // Teacher link builder
  function updateShareLink(){
    const params = {
      count: tCount.value,
      advance: tAdvance.value
    };
    if (tMode.value) params.mode = tMode.value;
    if (tStart.value === "1" && tMode.value) params.start = "1";
    shareLink.value = buildUrl(params);
  }

  async function copyShareLink(){
    const text = shareLink.value.trim();
    if(!text){
      copyStatus.textContent = "No link to copy yet.";
      return;
    }
    try{
      await navigator.clipboard.writeText(text);
      copyStatus.textContent = "Copied!";
    }catch(err){
      shareLink.focus();
      shareLink.select();
      try{
        document.execCommand("copy");
        copyStatus.textContent = "Copied!";
      }catch(e){
        copyStatus.textContent = "Couldn‚Äôt copy automatically ‚Äî select the link and copy it.";
      }
    }
    setTimeout(() => { copyStatus.textContent = ""; }, 1600);
  }

  tMode.addEventListener("change", updateShareLink);
  tCount.addEventListener("change", updateShareLink);
  tAdvance.addEventListener("change", updateShareLink);
  tStart.addEventListener("change", updateShareLink);
  copyLinkBtn.addEventListener("click", copyShareLink);

  // Navigation
  function goMenu(){
    resetRun();
    mode = null;
    hide(gameScreen);
    hide(resultScreen);
    show(menuScreen);

    // Keep teacher defaults synced to main settings unless teacher changes them
    tCount.value = String(TOTAL);
    tAdvance.value = advanceOnWrong ? "yes" : "no";
    updateShareLink();
  }

  function startMode(m){
    mode = m;

    hide(menuScreen);
    hide(resultScreen);
    show(gameScreen);

    resetRun();
    modeNameEl.textContent = MODE_INFO[m].name;

    const advText = advanceOnWrong ? "Advance on wrong: Yes" : "Advance on wrong: No";
    miniRuleEl.textContent = `${MODE_INFO[m].rule} ‚Ä¢ ${TOTAL} questions ‚Ä¢ ${advText}`;

    loadNextQuestion();
  }

  document.querySelectorAll("button[data-mode]").forEach(btn => {
    btn.addEventListener("click", () => startMode(btn.dataset.mode));
  });

  qBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      setMainCount(btn.dataset.count);
      // keep teacher count synced
      tCount.value = String(TOTAL);
      updateShareLink();
    });
  });

  advBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      setMainAdvance(btn.dataset.adv === "yes");
      tAdvance.value = advanceOnWrong ? "yes" : "no";
      updateShareLink();
    });
  });

  backBtn.addEventListener("click", goMenu);
  restartBtn.addEventListener("click", () => { if(mode) startMode(mode); });
  againBtn.addEventListener("click", () => { if(mode) startMode(mode); else goMenu(); });
  menuBtn.addEventListener("click", goMenu);

  // Apply URL params on load
  function applyParamsOnLoad(){
    const q = parseQuery();

    if(q.count && ["10","20","25","50"].includes(q.count)) setMainCount(q.count);
    else setMainCount(10);

    if(q.advance === "yes") setMainAdvance(true);
    else if(q.advance === "no") setMainAdvance(false);

    // Seed teacher fields
    tCount.value = String(TOTAL);
    tAdvance.value = advanceOnWrong ? "yes" : "no";

    if(q.mode && ["add","sub","mul","div"].includes(q.mode)) tMode.value = q.mode;
    else tMode.value = "";

    tStart.value = (q.start === "1") ? "1" : "0";

    updateShareLink();

    if(q.start === "1" && q.mode && ["add","sub","mul","div"].includes(q.mode)){
      startMode(q.mode);
    }else{
      goMenu();
    }
  }

  applyParamsOnLoad();
})();
</script>
</body>
</html>
