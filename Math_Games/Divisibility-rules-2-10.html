<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Divisibility Rules (2–10) — Learn & Test</title>
  <style>
    :root{
      --bg:#0b0d12;
      --card:#121625;
      --card2:#0f1320;
      --text:#e9ecf1;
      --muted:#a8b0c2;
      --line:#232a3f;
      --accent:#7aa2ff;
      --good:#46d18a;
      --bad:#ff5c7a;
      --warn:#ffd166;
      --shadow: 0 14px 45px rgba(0,0,0,.45);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1100px 600px at 20% -10%, rgba(122,162,255,.22), transparent 60%),
                  radial-gradient(900px 500px at 110% 30%, rgba(70,209,138,.13), transparent 55%),
                  radial-gradient(900px 500px at 10% 120%, rgba(255,92,122,.10), transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 22px 18px 34px;
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 280px;
    }
    h1{
      margin:0;
      font-size: clamp(20px, 2.6vw, 30px);
      font-weight: 850;
      letter-spacing: .2px;
      line-height:1.15;
    }
    .subtitle{
      color:var(--muted);
      font-size: 14px;
      line-height: 1.35;
    }
    .tabs{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tabbtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 700;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .tabbtn:hover{transform: translateY(-1px); border-color:#2f3753}
    .tabbtn.active{
      background: rgba(122,162,255,.14);
      border-color: rgba(122,162,255,.55);
      box-shadow: 0 12px 30px rgba(122,162,255,.10);
    }

    .grid{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns: 1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 14px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: rgba(0,0,0,.10);
    }
    .card .hd h2{
      margin:0;
      font-size: 16px;
      font-weight: 850;
      letter-spacing:.2px;
    }
    .card .bd{padding: 14px}
    .muted{color:var(--muted)}
    .pill{
      font-family:var(--mono);
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      white-space:nowrap;
    }
    .btn{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 800;
      transition: transform .08s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); border-color:#2f3753}
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none}
    .btn.primary{
      background: rgba(122,162,255,.18);
      border-color: rgba(122,162,255,.65);
    }
    .btn.good{
      background: rgba(70,209,138,.14);
      border-color: rgba(70,209,138,.55);
    }
    .btn.bad{
      background: rgba(255,92,122,.12);
      border-color: rgba(255,92,122,.55);
    }

    .numRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .numBtn{
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      cursor:pointer;
      font-weight: 900;
      font-size: 16px;
      display:grid;
      place-items:center;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .numBtn:hover{transform: translateY(-1px); border-color:#2f3753}
    .numBtn.active{
      background: rgba(122,162,255,.16);
      border-color: rgba(122,162,255,.65);
      box-shadow: 0 12px 24px rgba(122,162,255,.10);
    }

    .ruleBox{
      padding: 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
    }
    .ruleTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .ruleTitle .big{
      font-size: 18px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .ruleText{
      line-height: 1.45;
      color: var(--text);
      font-size: 14px;
    }
    .examples{
      margin-top: 12px;
      display:grid;
      gap:10px;
    }
    .exRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tag{
      font-size: 12px;
      font-weight: 900;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }
    .chip{
      font-family: var(--mono);
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
    }
    .chip.good{border-color: rgba(70,209,138,.55); background: rgba(70,209,138,.10)}
    .chip.bad{border-color: rgba(255,92,122,.55); background: rgba(255,92,122,.08); color: #ffd3db}

    .checkGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 420px){
      .check .t{font-size: 11px;}
    }
/* Select All row */
    .selectAll{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      margin-bottom: 10px;
      user-select:none;
    }
    .selectAll .left{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 950;
      font-size: 13px;
    }
    .selectAll input{transform: scale(1.15); margin-top: 1px}
    .selectAll .hint{color: var(--muted); font-size: 12px; white-space: nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 45%;}
    @media (max-width: 520px){
      .selectAll .hint{display:none;}
    }
    @media (max-width: 500px){
      .checkGrid{grid-template-columns: repeat(2, minmax(0, 1fr))}
    }
    .check{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 10px 12px;
      min-height: 56px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      overflow:hidden;
    }
    .check input{
      flex: 0 0 auto;
      transform: scale(1.1);
      margin: 0;
      accent-color: var(--accent);
    }
    .check .n{
      flex: 0 0 auto;
      font-weight: 950;
      font-size: 18px;
      width: 22px;
      text-align:center;
      line-height: 1;
    }
    .check .t{
      flex: 1 1 auto;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.2;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }

    .qArea{
      display:grid;
      gap: 12px;
    }
    .qTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .progress{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      overflow:hidden;
      flex: 1;
      min-width: 220px;
    }
    .bar{
      height:100%;
      width:0%;
      background: rgba(122,162,255,.75);
    }
    .qPrompt{
      padding: 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
    }
    .qPrompt .small{
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      letter-spacing:.25px;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    .qPrompt .big{
      font-family: var(--mono);
      font-size: clamp(24px, 4.2vw, 34px);
      font-weight: 950;
      letter-spacing: .4px;
      display:flex;
      gap:10px;
      align-items:baseline;
      flex-wrap:wrap;
    }
    .qPrompt .big span{opacity:.9}
    .qPrompt .big .d{
      padding: 2px 10px;
      border-radius: 12px;
      border: 1px solid rgba(122,162,255,.55);
      background: rgba(122,162,255,.14);
    }
    .ansRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .feedback{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      line-height: 1.35;
    }
    .feedback.good{border-color: rgba(70,209,138,.55); background: rgba(70,209,138,.08); color: #d8ffe9}
    .feedback.bad{border-color: rgba(255,92,122,.55); background: rgba(255,92,122,.06); color: #ffd3db}

    .resultsList{
      display:grid;
      gap: 10px;
      margin-top: 10px;
    }
    .resItem{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .resLeft{display:flex; flex-direction:column; gap:4px}
    .resLeft .a{
      font-family: var(--mono);
      font-weight: 950;
      letter-spacing:.2px;
    }
    .resLeft .b{color:var(--muted); font-size:12px}
    .resRight{
      font-weight: 950;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      white-space:nowrap;
      margin-top: 2px;
    }
    .resRight.good{border-color: rgba(70,209,138,.55); background: rgba(70,209,138,.10)}
    .resRight.bad{border-color: rgba(255,92,122,.55); background: rgba(255,92,122,.08)}
    footer{
      margin-top: 16px;
      color: var(--muted);
      font-size: 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .kbd{
      font-family:var(--mono);
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding: 2px 6px;
      border-radius: 8px;
      color: var(--muted);
    }
    .hidden{display:none !important}
  
    .check .t{display:none;}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Divisibility Rules (2–10)</h1>
        <div class="subtitle">Tutorial mode teaches the rules with examples. Testing mode quizzes students with 10 random 3-digit numbers for the rules they choose.</div>
      </div>
      <div class="tabs" role="tablist" aria-label="Mode">
        <button class="tabbtn active" id="tabTutorial" type="button" role="tab" aria-selected="true">Tutorial</button>
        <button class="tabbtn" id="tabTest" type="button" role="tab" aria-selected="false">Testing</button>
      </div>
    </header>

    <div class="grid">
      <!-- Left: Tutorial selector / Test setup -->
      <section class="card" id="leftCard">
        <div class="hd">
          <h2 id="leftTitle">Pick a rule</h2>
          <span class="pill" id="leftPill">2–10</span>
        </div>
        <div class="bd" id="leftBody">

          <!-- Tutorial selector -->
          <div id="tutorialPicker">
            <div class="muted" style="font-size:13px; margin-bottom:10px;">Click a number to learn its divisibility rule.</div>
            <div class="numRow" id="numRow"></div>
            <div style="height:12px"></div>
            <div class="muted" style="font-size:12px; line-height:1.35;">
              Tip: In testing mode, you’ll get questions like “Is <span class="kbd">684</span> divisible by <span class="kbd">6</span>?”
            </div>
          </div>

          <!-- Test setup -->
          <div id="testSetup" class="hidden">
            <div class="muted" style="font-size:13px; margin-bottom:10px;">Choose which divisibility rules you want to practice (you can pick more than one).</div>
            <div class="selectAll" id="selectAllRow">
  <div class="left">
    <input type="checkbox" id="selectAll" />
    <div>Select all (2–10)</div>
  </div>
  <div class="hint">Quickly choose every rule</div>
</div>
<div class="checkGrid" id="checkGrid"></div>
            <div style="height:12px"></div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn primary" id="btnStart" type="button" disabled>Start 10 Questions</button>
              <button class="btn" id="btnReset" type="button">Reset</button>
            </div>
            <div class="muted" style="font-size:12px; margin-top:10px; line-height:1.35;">
              Each question uses a random 3-digit number (100–999) and one of your chosen divisors.
            </div>
          </div>

        </div>
      </section>

      <!-- Right: Tutorial content / Test player -->
      <section class="card" id="rightCard">
        <div class="hd">
          <h2 id="rightTitle">Divisible by 2</h2>
          <span class="pill" id="rightPill">Tutorial</span>
        </div>
        <div class="bd">

          <!-- Tutorial view -->
          <div id="tutorialView">
            <div class="ruleBox">
              <div class="ruleTitle">
                <div class="big" id="ruleHeading">Rule for 2</div>
                <span class="pill" id="ruleMini">Click 2–10</span>
              </div>
              <div class="ruleText" id="ruleText"></div>

              <div class="examples" id="examples"></div>
            </div>

            <div style="height:12px"></div>
            <div class="feedback" id="extraNote">
              In testing mode, try using the rule quickly without long division.
            </div>
          </div>

          <!-- Testing view -->
          <div id="testView" class="hidden">
            <div class="qArea">
              <div class="qTop">
                <div class="progress" aria-label="Progress">
                  <div class="bar" id="bar"></div>
                </div>
                <div class="pill" id="scorePill">Score: 0 / 0</div>
              </div>

              <div class="qPrompt" id="qPrompt">
                <div class="small">Question</div>
                <div class="big">
                  <span>Is</span> <span id="qNumber">---</span> <span>divisible by</span> <span class="d" id="qDiv">-</span><span>?</span>
                </div>
              </div>

              <div class="ansRow" id="ansRow">
                <button class="btn good" id="btnYes" type="button">Yes</button>
                <button class="btn bad" id="btnNo" type="button">No</button>
                <button class="btn" id="btnShowRule" type="button">Show Rule</button>
              </div>

              <div class="feedback hidden" id="fb"></div>

              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn primary" id="btnNext" type="button" disabled>Next</button>
                <button class="btn" id="btnQuit" type="button">Quit</button>
              </div>

              <div class="hidden" id="results">
                <div class="ruleBox" style="margin-top:8px;">
                  <div class="ruleTitle">
                    <div class="big" id="resultsTitle">Results</div>
                    <span class="pill" id="resultsPill">10 questions</span>
                  </div>
                  <div class="muted" style="font-size:13px; line-height:1.35;">
                    Review what you got right and wrong below. Try again with different rules any time.
                  </div>

                  <div class="resultsList" id="resultsList"></div>

                  <div style="height:12px"></div>
                  <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn primary" id="btnPlayAgain" type="button">Play Again</button>
                    <button class="btn" id="btnBackToSetup" type="button">Back to Setup</button>
                  </div>
                </div>
              </div>

            </div>
          </div>

        </div>
      </section>
    </div>

    <footer>
      <div>Made for quick practice: rules 2–10, 3-digit numbers, 10-question quiz.</div>
      <div><span class="kbd">Tip</span> Use the “Show Rule” button if you get stuck.</div>
    </footer>
  </div>

<script>
(() => {
  "use strict";

  // ----- Rules content (2–10) -----
  const RULES = {
    2: {
      rule: "A number is divisible by 2 if its last digit is even (0, 2, 4, 6, or 8).",
      why: "Even numbers can be split into 2 equal groups.",
      examplesGood: [684, 120, 918, 742],
      examplesBad: [513, 907, 665, 231],
    },
    3: {
      rule: "A number is divisible by 3 if the sum of its digits is divisible by 3.",
      why: "Digits add up in a way that preserves divisibility by 3.",
      examplesGood: [834, 741, 999, 312],
      examplesBad: [542, 701, 418, 997],
    },
    4: {
      rule: "A number is divisible by 4 if the last two digits form a number divisible by 4.",
      why: "100 is divisible by 4, so only the last two digits matter.",
      examplesGood: [812, 736, 924, 504],
      examplesBad: [718, 935, 642, 301],
    },
    5: {
      rule: "A number is divisible by 5 if it ends in 0 or 5.",
      why: "Multiples of 5 always end in 0 or 5.",
      examplesGood: [615, 240, 905, 750],
      examplesBad: [612, 243, 908, 752],
    },
    6: {
      rule: "A number is divisible by 6 if it is divisible by BOTH 2 and 3.",
      why: "6 = 2 × 3, so both rules must be true.",
      examplesGood: [312, 684, 726, 918],
      examplesBad: [514, 735, 602, 711],
    },
    7: {
      rule: "One quick test: double the last digit and subtract it from the rest. If the result is divisible by 7 (including 0), then the original number is divisible by 7. Repeat if needed.",
      why: "This transforms the number without changing divisibility by 7.",
      examplesGood: [343, 854, 707, 896],
      examplesBad: [342, 855, 705, 894],
      note: "Example: 203 → 20 − (2×3)=14, and 14 is divisible by 7, so 203 is divisible by 7."
    },
    8: {
      rule: "A number is divisible by 8 if the last three digits form a number divisible by 8.",
      why: "1000 is divisible by 8, so only the last three digits matter.",
      examplesGood: [512, 736, 824, 968],
      examplesBad: [514, 739, 821, 967],
    },
    9: {
      rule: "A number is divisible by 9 if the sum of its digits is divisible by 9.",
      why: "Digit sums preserve divisibility by 9.",
      examplesGood: [729, 891, 999, 657],
      examplesBad: [728, 892, 998, 658],
    },
    10: {
      rule: "A number is divisible by 10 if it ends in 0.",
      why: "Multiples of 10 always end in 0.",
      examplesGood: [120, 450, 990, 700],
      examplesBad: [121, 455, 995, 701],
    }
  };

  // ----- DOM -----
  const tabTutorial = document.getElementById("tabTutorial");
  const tabTest = document.getElementById("tabTest");

  const tutorialPicker = document.getElementById("tutorialPicker");
  const testSetup = document.getElementById("testSetup");

  const leftTitle = document.getElementById("leftTitle");
  const rightTitle = document.getElementById("rightTitle");
  const rightPill = document.getElementById("rightPill");

  const tutorialView = document.getElementById("tutorialView");
  const testView = document.getElementById("testView");

  const numRow = document.getElementById("numRow");
  const ruleHeading = document.getElementById("ruleHeading");
  const ruleText = document.getElementById("ruleText");
  const examples = document.getElementById("examples");
  const extraNote = document.getElementById("extraNote");

  const checkGrid = document.getElementById("checkGrid");
  const selectAll = document.getElementById("selectAll");
  const btnStart = document.getElementById("btnStart");
  const btnReset = document.getElementById("btnReset");

  const bar = document.getElementById("bar");
  const scorePill = document.getElementById("scorePill");
  const qNumber = document.getElementById("qNumber");
  const qDiv = document.getElementById("qDiv");
  const btnYes = document.getElementById("btnYes");
  const btnNo = document.getElementById("btnNo");
  const btnShowRule = document.getElementById("btnShowRule");
  const fb = document.getElementById("fb");
  const btnNext = document.getElementById("btnNext");
  const btnQuit = document.getElementById("btnQuit");

  const results = document.getElementById("results");
  const resultsList = document.getElementById("resultsList");
  const resultsPill = document.getElementById("resultsPill");
  const btnPlayAgain = document.getElementById("btnPlayAgain");
  const btnBackToSetup = document.getElementById("btnBackToSetup");

  // ----- State -----
  let currentTutorialN = 2;

  let selectedDivisors = new Set();
  let quiz = [];  // {n, d, correctBool}
  let idx = 0;
  let score = 0;
  let answered = false;

  // ----- Helpers -----
  const clamp = (x, a, b) => Math.max(a, Math.min(b, x));
  const isDiv = (n, d) => (n % d) === 0;

  function pickRandom3Digit() {
    return 100 + Math.floor(Math.random() * 900); // 100–999
  }

  function setActiveTab(which) {
    const tutorial = which === "tutorial";

    tabTutorial.classList.toggle("active", tutorial);
    tabTutorial.setAttribute("aria-selected", tutorial ? "true" : "false");
    tabTest.classList.toggle("active", !tutorial);
    tabTest.setAttribute("aria-selected", tutorial ? "false" : "true");

    tutorialPicker.classList.toggle("hidden", !tutorial);
    testSetup.classList.toggle("hidden", tutorial);

    tutorialView.classList.toggle("hidden", !tutorial);
    testView.classList.toggle("hidden", tutorial);

    leftTitle.textContent = tutorial ? "Pick a rule" : "Choose rules to practice";
    rightTitle.textContent = tutorial ? `Divisible by ${currentTutorialN}` : "Testing";
    rightPill.textContent = tutorial ? "Tutorial" : "Testing";
  }

  function renderTutorial(n) {
    currentTutorialN = n;

    // highlight button
    [...numRow.querySelectorAll(".numBtn")].forEach(btn => {
      btn.classList.toggle("active", Number(btn.dataset.n) === n);
    });

    const r = RULES[n];
    rightTitle.textContent = `Divisible by ${n}`;
    ruleHeading.textContent = `Rule for ${n}`;

    const extra = r.note ? `<div style="margin-top:10px" class="muted"><strong style="color:#e9ecf1">Example:</strong> ${escapeHtml(r.note)}</div>` : "";
    ruleText.innerHTML = `
      <div>${escapeHtml(r.rule)}</div>
      <div style="margin-top:10px" class="muted"><strong style="color:#e9ecf1">Why it works:</strong> ${escapeHtml(r.why)}</div>
      ${extra}
    `;

    // examples
    const good = r.examplesGood.map(x => `<span class="chip good">${x}</span>`).join("");
    const bad = r.examplesBad.map(x => `<span class="chip bad">${x}</span>`).join("");

    examples.innerHTML = `
      <div class="exRow">
        <span class="tag">Divisible</span>
        ${good}
      </div>
      <div class="exRow">
        <span class="tag">Not divisible</span>
        ${bad}
      </div>
    `;

    extraNote.textContent = "In testing mode, try using the rule quickly without long division.";
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function updateStartBtn() {
    btnStart.disabled = selectedDivisors.size === 0;
  }

  function refreshSelectAll() {
    if (!selectAll) return;
    const all = (selectedDivisors.size === 9); // 2..10
    const none = (selectedDivisors.size === 0);
    selectAll.indeterminate = !all && !none;
    selectAll.checked = all;
  }

  function buildQuiz() {
    const ds = [...selectedDivisors].sort((a,b)=>a-b);
    quiz = [];
    for (let i=0; i<10; i++){
      const d = ds[Math.floor(Math.random() * ds.length)];
      const n = pickRandom3Digit();
      quiz.push({ n, d, correct: isDiv(n, d) });
    }
    idx = 0;
    score = 0;
    answered = false;
  }

  function updateProgress() {
    const pct = quiz.length ? ((idx) / quiz.length) * 100 : 0;
    bar.style.width = `${clamp(pct, 0, 100)}%`;
    scorePill.textContent = `Score: ${score} / ${idx}`;
  }

  function showQuestion() {
    results.classList.add("hidden");
    fb.classList.add("hidden");
    fb.classList.remove("good","bad");
    fb.textContent = "";
    btnNext.disabled = true;
    answered = false;

    const q = quiz[idx];
    qNumber.textContent = q.n;
    qDiv.textContent = q.d;

    const pct = quiz.length ? ((idx) / quiz.length) * 100 : 0;
    bar.style.width = `${clamp(pct, 0, 100)}%`;
    scorePill.textContent = `Score: ${score} / ${idx}`;
  }

  function lockAnswer() {
    btnYes.disabled = true;
    btnNo.disabled = true;
    btnShowRule.disabled = true;
  }

  function unlockAnswer() {
    btnYes.disabled = false;
    btnNo.disabled = false;
    btnShowRule.disabled = false;
  }

  function answer(userSaysYes) {
    if (answered) return;
    answered = true;

    const q = quiz[idx];
    const correctYes = q.correct;
    const isRight = (userSaysYes === correctYes);

    if (isRight) score++;

    fb.classList.remove("hidden");
    fb.classList.toggle("good", isRight);
    fb.classList.toggle("bad", !isRight);

    const truth = correctYes ? "Yes" : "No";
    const ruleSnippet = RULES[q.d].rule;

    fb.innerHTML = `
      <div style="font-weight:900; margin-bottom:4px;">${isRight ? "Correct!" : "Not quite."}</div>
      <div style="margin-bottom:6px;">Answer: <span style="font-weight:900">${truth}</span> — ${q.n} ${correctYes ? "is" : "is not"} divisible by ${q.d}.</div>
      <div class="muted" style="font-size:12px; line-height:1.35;"><strong style="color:#e9ecf1">Rule:</strong> ${escapeHtml(ruleSnippet)}</div>
    `;

    lockAnswer();
    btnNext.disabled = false;
    scorePill.textContent = `Score: ${score} / ${idx + 1}`;

    // Update bar to show current answered
    const pct = quiz.length ? ((idx + 1) / quiz.length) * 100 : 0;
    bar.style.width = `${clamp(pct, 0, 100)}%`;
  }

  function finishQuiz() {
    // build results list
    resultsList.innerHTML = "";
    for (let i=0; i<quiz.length; i++){
      const q = quiz[i];
      const userWasRight = q.userCorrect === true;
      const badge = userWasRight ? "Correct" : "Incorrect";
      const badgeClass = userWasRight ? "good" : "bad";
      const truth = q.correct ? "Yes" : "No";
      const item = document.createElement("div");
      item.className = "resItem";
      item.innerHTML = `
        <div class="resLeft">
          <div class="a">#${i+1} — Is ${q.n} divisible by ${q.d}?</div>
          <div class="b">Correct answer: ${truth}. Rule: ${escapeHtml(RULES[q.d].rule)}</div>
        </div>
        <div class="resRight ${badgeClass}">${badge}</div>
      `;
      resultsList.appendChild(item);
    }

    resultsPill.textContent = `Score: ${score} / ${quiz.length}`;
    results.classList.remove("hidden");

    // hide Q controls
    fb.classList.add("hidden");
    btnNext.disabled = true;
    lockAnswer();
  }

  // ----- Build UI controls -----
  function initTutorialButtons() {
    for (let n=2; n<=10; n++){
      const b = document.createElement("button");
      b.type = "button";
      b.className = "numBtn";
      b.dataset.n = String(n);
      b.textContent = String(n);
      b.addEventListener("click", () => renderTutorial(n));
      numRow.appendChild(b);
    }
    renderTutorial(2);
  }

  function initCheckboxes() {
    for (let n=2; n<=10; n++){
      const label = document.createElement("label");
      label.className = "check";
      label.innerHTML = `
        <input type="checkbox" data-n="${n}" />
        <div class="n">${n}</div>
        <div class="t"></div>
      `;
      const cb = label.querySelector("input");
      cb.addEventListener("change", () => {
        const k = Number(cb.dataset.n);
        if (cb.checked) selectedDivisors.add(k);
        else selectedDivisors.delete(k);
        updateStartBtn();
        refreshSelectAll();
      });
      checkGrid.appendChild(label);
    }
  }

  // ----- Mode switching -----
  tabTutorial.addEventListener("click", () => setActiveTab("tutorial"));
  tabTest.addEventListener("click", () => setActiveTab("test"));

  // ----- Test setup actions -----
  btnReset.addEventListener("click", () => {
    selectedDivisors.clear();
    [...checkGrid.querySelectorAll("input[type=checkbox]")].forEach(cb => cb.checked = false);
    updateStartBtn();
    refreshSelectAll();
    // reset testing view if needed
    results.classList.add("hidden");
    fb.classList.add("hidden");
    unlockAnswer();
    qNumber.textContent = "---";
    qDiv.textContent = "-";
    bar.style.width = "0%";
    scorePill.textContent = "Score: 0 / 0";
  });

  btnStart.addEventListener("click", () => {
    buildQuiz();
    // attach a spot to store whether student got it right
    quiz.forEach(q => q.userCorrect = false);

    // move to test tab and show first question
    setActiveTab("test");
    rightTitle.textContent = "Testing";
    unlockAnswer();
    showQuestion();
  });

  // ----- Quiz actions -----
  btnYes.addEventListener("click", () => {
    const q = quiz[idx];
    const correct = (q.correct === true);
    q.userCorrect = (true === q.correct);
    answer(true);
    q.userCorrect = (true === q.correct);
  });

  btnNo.addEventListener("click", () => {
    const q = quiz[idx];
    q.userCorrect = (false === q.correct);
    answer(false);
    q.userCorrect = (false === q.correct);
  });

  btnShowRule.addEventListener("click", () => {
    const q = quiz[idx];
    // show in tutorial box inline (doesn't switch tabs)
    fb.classList.remove("hidden");
    fb.classList.remove("good","bad");
    fb.innerHTML = `
      <div style="font-weight:900; margin-bottom:4px;">Rule for ${q.d}</div>
      <div style="line-height:1.35; margin-bottom:6px;">${escapeHtml(RULES[q.d].rule)}</div>
      <div class="muted" style="font-size:12px;">Tip: Use this rule to decide “Yes” or “No”.</div>
    `;
  });

  btnNext.addEventListener("click", () => {
    if (!answered) return;
    idx++;

    if (idx >= quiz.length){
      // finalize
      // update score pill
      scorePill.textContent = `Score: ${score} / ${quiz.length}`;
      finishQuiz();
      return;
    }

    unlockAnswer();
    showQuestion();
  });

  btnQuit.addEventListener("click", () => {
    // back to setup without losing checkbox selection
    results.classList.add("hidden");
    fb.classList.add("hidden");
    unlockAnswer();
    qNumber.textContent = "---";
    qDiv.textContent = "-";
    bar.style.width = "0%";
    scorePill.textContent = "Score: 0 / 0";
    // show setup (still in Testing tab)
    setActiveTab("test");
  });

  btnPlayAgain.addEventListener("click", () => {
    // reuse same selected rules
    if (selectedDivisors.size === 0){
      // shouldn't happen, but safeguard
      setActiveTab("test");
      return;
    }
    buildQuiz();
    quiz.forEach(q => q.userCorrect = false);
    unlockAnswer();
    showQuestion();
  });

  btnBackToSetup.addEventListener("click", () => {
    results.classList.add("hidden");
    fb.classList.add("hidden");
    unlockAnswer();
    qNumber.textContent = "---";
    qDiv.textContent = "-";
    bar.style.width = "0%";
    scorePill.textContent = "Score: 0 / 0";
    setActiveTab("test");
  });

  // ----- Init -----
  initTutorialButtons();
  initCheckboxes();
  if (selectAll){
    selectAll.addEventListener("change", () => {
      const checked = selectAll.checked;
      selectedDivisors.clear();
      const cbs = [...checkGrid.querySelectorAll('input[type=checkbox][data-n]')];
      for (const cb of cbs){
        cb.checked = checked;
        if (checked) selectedDivisors.add(Number(cb.dataset.n));
      }
      updateStartBtn();
      refreshSelectAll();
    });
  }
  refreshSelectAll();
  updateStartBtn();
  setActiveTab("tutorial");

})();
</script>
</body>
</html>
