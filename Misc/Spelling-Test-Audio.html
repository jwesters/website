<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spelling Test (Audio)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      margin:0; padding:24px;
      background:#fff; color:#111;
    }
    .wrap{ max-width:760px; margin:0 auto; }
    h1{ font-size:1.4rem; margin:0 0 12px; }
    p{ margin:8px 0 14px; color:#333; }
    textarea, input{
      width:100%;
      font-size:1rem;
      padding:10px 12px;
      border:1px solid #ccc;
      border-radius:10px;
      box-sizing:border-box;
    }
    textarea{ min-height:170px; resize:vertical; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      font-size:1rem;
      padding:10px 12px;
      border:1px solid #bbb;
      background:#f7f7f7;
      border-radius:10px;
      cursor:pointer;
    }
    button:hover{ background:#eee; }
    button.primary{
      background:#111; color:#fff; border-color:#111;
    }
    button.primary:hover{ background:#000; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .card{
      border:1px solid #e3e3e3;
      border-radius:16px;
      padding:16px;
      background:#fff;
      box-shadow: 0 1px 8px rgba(0,0,0,.04);
    }
    .muted{ color:#555; font-size:.95rem; }
    .tiny{ color:#666; font-size:.9rem; }
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid #ddd;
      background:#fafafa;
      font-size:.9rem;
      color:#444;
    }
    .warn{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #f0c36d;
      background:#fff7e6;
      color:#8a5a00;
      font-size:.9rem;
    }
    .feedback{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #ddd;
      background:#fafafa;
      min-height:44px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .ok{ border-color:#cfe9d6; background:#f3fbf5; }
    .bad{ border-color:#f1c5c5; background:#fff5f5; }
    .list{
      margin-top:12px;
      border-top:1px solid #eee;
      padding-top:12px;
    }
    .miss{
      padding:10px 12px;
      border:1px solid #eee;
      border-radius:12px;
      margin:10px 0;
      background:#fcfcfc;
    }
    .hr{ height:1px; background:#eee; margin:14px 0; }
    .hide{ display:none !important; }
    .seg{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin:10px 0 2px;
    }
    .seg label{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:12px;
      background:#fafafa;
      cursor:pointer;
      user-select:none;
    }
    .seg input{ width:auto; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Spelling Test (Audio)</h1>

    <div id="teacherView" class="card hide">
      <p class="muted">
        Paste a list of words (one per line). Optional sentence format:
        <span class="pill">word, "Sentence using the word."</span>
      </p>

      <label class="tiny" for="wordsBox">Word list</label>
      <textarea id="wordsBox" placeholder='cat, "The cat was outside."&#10;because, "I stayed inside because it was cold."&#10;Christmas'></textarea>

      <div class="seg" aria-label="Order selection">
        <span class="tiny" style="min-width:110px;">Word order</span>
        <label><input type="radio" name="orderMode" value="inorder" checked> Same order</label>
        <label><input type="radio" name="orderMode" value="random"> Random</label>
      </div>

      <div class="seg" aria-label="Case sensitivity">
        <span class="tiny" style="min-width:110px;">Case checking</span>
        <label><input type="radio" name="caseMode" value="insensitive" checked> Case-insensitive</label>
        <label><input type="radio" name="caseMode" value="sensitive"> Case-sensitive</label>
      </div>

      <div class="tiny" style="margin-top:6px;">
        These choices are saved in the share link and can‚Äôt be changed once the test starts.
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="primary" id="startLocalBtn">Start test</button>
        <button id="shareBtn">Generate share link</button>
        <button id="clearBtn">Clear</button>
      </div>

      <div class="hr"></div>

      <div>
        <div class="tiny" style="margin-bottom:6px;">Share link (encoded)</div>
        <input id="shareLink" type="text" readonly placeholder="Click ‚ÄúGenerate share link‚Äù" />
        <div class="row" style="margin-top:10px;">
          <button id="copyBtn">Copy link</button>
          <span class="tiny" id="copyMsg" aria-live="polite"></span>
        </div>
        <p class="tiny" style="margin-top:12px;">
          Note: this is a simple encode/obfuscate (ROT13 + Base64). Anyone with the link could still decode it if they try.
        </p>
      </div>
    </div>

    <div id="testView" class="card hide">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="row" style="align-items:center;">
          <span class="pill" id="progressPill">Word 1 of 1</span>
          <span id="caseNotice" class="warn hide">Case-sensitive</span>
        </div>
        <button id="restartBtn">Restart</button>
      </div>

      <div style="margin-top:14px;">
        <p class="muted" style="margin-bottom:10px;">Click <b>Hear word</b>, then type what you heard.</p>

        <div class="row">
          <button class="primary" id="hearBtn">Hear word</button>
          <button id="sentenceBtn" class="hide">Word used in a sentence</button>
        </div>

        <div style="margin-top:12px;">
          <label class="tiny" for="answerInput">Your spelling</label>
          <input id="answerInput" type="text" autocomplete="off" spellcheck="false" />
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="primary" id="submitBtn">Check</button>
        </div>

        <div id="feedbackBox" class="feedback" aria-live="polite"></div>

        <div class="tiny" style="margin-top:12px;">
          Tip: If audio doesn‚Äôt play, your browser may require a click first‚Äîpress <b>Hear word</b>.
        </div>
      </div>
    </div>

    <div id="resultsView" class="card hide">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="row">
          <button id="retryBtn">Retry Test</button>
          <span class="pill" id="scorePill">Score: 0/0</span>
        </div>
        <button id="newTestBtn" class="primary">New test</button>
      </div>

      <div id="missedList" class="list"></div>
    </div>
  </div>

  <script>
    function rot13(str){
      return str.replace(/[a-zA-Z]/g, c => {
        const base = c <= 'Z' ? 65 : 97;
        return String.fromCharCode(((c.charCodeAt(0) - base + 13) % 26) + base);
      });
    }
    function b64EncodeUtf8(str){ return btoa(unescape(encodeURIComponent(str))); }
    function b64DecodeUtf8(str){ return decodeURIComponent(escape(atob(str))); }
    function encodeWords(wordsText){ return rot13(b64EncodeUtf8(wordsText)); }
    function decodeWords(encoded){ return b64DecodeUtf8(rot13(encoded)); }

    function shuffle(arr){
      for (let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    function speak(text){
      if (!("speechSynthesis" in window)) return false;
      try{
        const u = new SpeechSynthesisUtterance(text);
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
        return true;
      }catch{ return false; }
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, ch => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[ch]));
    }

    function parseLine(line){
      const raw = (line || "").trim();
      if (!raw) return null;
      const m = raw.match(/^\s*([^,]+?)\s*,\s*"([^"]+)"\s*$/);
      if (m){
        const word = (m[1] || "").trim();
        const sentence = (m[2] || "").trim();
        if (!word) return null;
        return { word, sentence: sentence || null };
      }
      return { word: raw, sentence: null };
    }

    function parseList(text){
      return (text || "")
        .split(/\r?\n/)
        .map(parseLine)
        .filter(x => x && x.word);
    }

    const teacherView = document.getElementById("teacherView");
    const testView = document.getElementById("testView");
    const resultsView = document.getElementById("resultsView");

    const wordsBox = document.getElementById("wordsBox");
    const startLocalBtn = document.getElementById("startLocalBtn");
    const shareBtn = document.getElementById("shareBtn");
    const clearBtn = document.getElementById("clearBtn");
    const shareLink = document.getElementById("shareLink");
    const copyBtn = document.getElementById("copyBtn");
    const copyMsg = document.getElementById("copyMsg");

    const progressPill = document.getElementById("progressPill");
    const caseNotice = document.getElementById("caseNotice");
    const hearBtn = document.getElementById("hearBtn");
    const sentenceBtn = document.getElementById("sentenceBtn");
    const answerInput = document.getElementById("answerInput");
    const submitBtn = document.getElementById("submitBtn");
    const feedbackBox = document.getElementById("feedbackBox");
    const restartBtn = document.getElementById("restartBtn");

    const scorePill = document.getElementById("scorePill");
    const missedList = document.getElementById("missedList");
    const newTestBtn = document.getElementById("newTestBtn");
    const retryBtn = document.getElementById("retryBtn");

    function show(view){
      teacherView.classList.add("hide");
      testView.classList.add("hide");
      resultsView.classList.add("hide");
      view.classList.remove("hide");
    }
    function setFeedback(type, html){
      feedbackBox.className = "feedback";
      if (type === "ok") feedbackBox.classList.add("ok");
      if (type === "bad") feedbackBox.classList.add("bad");
      feedbackBox.innerHTML = html || "";
    }

    function getSelectedOrderMode(){
      const el = document.querySelector('input[name="orderMode"]:checked');
      return el ? el.value : "inorder";
    }
    function getSelectedCaseMode(){
      const el = document.querySelector('input[name="caseMode"]:checked');
      return el ? el.value : "insensitive";
    }

    let items = [];
    let order = [];
    let idx = 0;
    let results = [];
    let orderMode = "inorder";
    let caseMode = "insensitive";
    let locked = false;

    function buildOrder(fromItems, mode){
      const base = fromItems.slice();
      return (mode === "random") ? shuffle(base) : base;
    }

    function startTest(fromItems, mode, cMode){
      items = [...fromItems];
      if (!items.length){
        alert("Please provide at least one word.");
        return;
      }
      orderMode = (mode === "random") ? "random" : "inorder";
      caseMode = (cMode === "sensitive") ? "sensitive" : "insensitive";
      order = buildOrder(items, orderMode);
      idx = 0;
      results = [];
      locked = false;
      submitBtn.disabled = false;

      show(testView);
      setFeedback("", "Ready when you are.");
      answerInput.value = "";
      answerInput.focus();
      updateUIForCurrent();

      if (caseMode === "sensitive"){
        caseNotice.classList.remove("hide");
      } else {
        caseNotice.classList.add("hide");
      }
    }

    function currentItem(){ return order[idx] || null; }

    function updateUIForCurrent(){
      progressPill.textContent = `Word ${Math.min(idx + 1, order.length)} of ${order.length}`;
      const it = currentItem();
      if (it && it.sentence) sentenceBtn.classList.remove("hide");
      else sentenceBtn.classList.add("hide");
    }

    function playWord(){
      const it = currentItem();
      if (!it) return;
      const ok = speak(it.word);
      if (!ok) setFeedback("bad", "Sorry‚Äîyour browser doesn‚Äôt support speech synthesis.");
    }

    function playSentence(){
      const it = currentItem();
      if (!it || !it.sentence) return;
      const ok = speak(it.sentence);
      if (!ok) setFeedback("bad", "Sorry‚Äîyour browser doesn‚Äôt support speech synthesis.");
    }

    function checkAnswer(){
      if (locked) return;
      const it = currentItem();
      if (!it) return;

      locked = true;
      submitBtn.disabled = true;

      const typed = (answerInput.value || "").trim();
      const target = it.word;

      let correct;
      if (caseMode === "sensitive"){
        correct = typed === target;
      } else {
        correct = typed.toLowerCase() === target.toLowerCase();
      }

      results.push({ target, typed, correct });

      if (correct){
        setFeedback("ok", "‚úÖ Correct!");
      } else {
        setFeedback("bad", `‚ùå Not quite. Correct spelling: <b>${escapeHtml(target)}</b>`);
      }

      idx++;

      setTimeout(() => {
        if (idx >= order.length){
          finish();
        } else {
          answerInput.value = "";
          setFeedback("", "Next word ready.");
          updateUIForCurrent();
          answerInput.focus();
          locked = false;
          submitBtn.disabled = false;
        }
      }, 900);
    }

    function finish(){
      const correctCount = results.filter(r => r.correct).length;
      scorePill.textContent = `Score: ${correctCount}/${results.length}`;

      const missed = results.map((r,i)=>({ ...r, n:i+1 })).filter(r=>!r.correct);

      if (!missed.length){
        missedList.innerHTML = "<p class='muted' style='margin-top:12px;'>Perfect score üéâ</p>";
      } else {
        missedList.innerHTML =
          "<h2 style='font-size:1.05rem; margin:14px 0 6px;'>Missed words</h2>" +
          missed.map(m => `
            <div class="miss">
              <div class="tiny"><b>#${m.n}</b></div>
              <div style="margin-top:6px;"><b>Correct:</b> ${escapeHtml(m.target)}</div>
              <div style="margin-top:6px;"><b>You typed:</b> ${escapeHtml(m.typed || "(blank)")}</div>
            </div>
          `).join("");
      }
      show(resultsView);
    }

    // Share link params:
    //  w = encoded word list
    //  o = order mode: r|i
    //  c = case mode: s|i
    function buildShareLink(wordsText, mode, cMode){
      const encoded = encodeWords(wordsText);
      const url = new URL(window.location.href);
      const params = new URLSearchParams();
      params.set("w", encoded);
      params.set("o", mode === "random" ? "r" : "i");
      params.set("c", cMode === "sensitive" ? "s" : "i");
      url.hash = params.toString();
      return url.toString();
    }

    function getSharedConfig(){
      const hash = (window.location.hash || "").replace(/^#/, "");
      if (!hash) return null;
      const params = new URLSearchParams(hash);
      const w = params.get("w");
      if (!w) return null;
      const o = params.get("o") || "i";
      const c = params.get("c") || "i";
      const mode = (o === "r") ? "random" : "inorder";
      const cMode = (c === "s") ? "sensitive" : "insensitive";
      try{
        const text = decodeWords(decodeURIComponent(w));
        return { text, mode, cMode };
      }catch{
        return null;
      }
    }

    startLocalBtn.addEventListener("click", () => {
      const list = parseList(wordsBox.value);
      startTest(list, getSelectedOrderMode(), getSelectedCaseMode());
    });

    shareBtn.addEventListener("click", () => {
      const list = parseList(wordsBox.value);
      if (!list.length){
        alert("Please paste at least one word first.");
        return;
      }
      const normalizedText = list.map(it => it.sentence ? `${it.word}, "${it.sentence}"` : it.word).join("\n");
      const mode = getSelectedOrderMode();
      const cMode = getSelectedCaseMode();
      shareLink.value = buildShareLink(normalizedText, mode, cMode);
      copyMsg.textContent = "";
    });

    clearBtn.addEventListener("click", () => {
      wordsBox.value = "";
      shareLink.value = "";
      copyMsg.textContent = "";
      wordsBox.focus();
    });

    copyBtn.addEventListener("click", async () => {
      if (!shareLink.value) return;
      try{
        await navigator.clipboard.writeText(shareLink.value);
        copyMsg.textContent = "Copied!";
        setTimeout(() => copyMsg.textContent = "", 1200);
      }catch{
        shareLink.select();
        document.execCommand("copy");
        copyMsg.textContent = "Copied!";
        setTimeout(() => copyMsg.textContent = "", 1200);
      }
    });

    hearBtn.addEventListener("click", playWord);
    sentenceBtn.addEventListener("click", playSentence);

    submitBtn.addEventListener("click", checkAnswer);
    answerInput.addEventListener("keydown", (e) => { if (e.key === "Enter") checkAnswer(); });

    restartBtn.addEventListener("click", () => {
      startTest(items, orderMode, caseMode);
    });

    retryBtn.addEventListener("click", () => {
      // Retry the same test (same words, same settings; random reshuffles again)
      startTest(items, orderMode, caseMode);
    });

    newTestBtn.addEventListener("click", () => {
      window.location.hash = "";
      show(teacherView);
    });

    const shared = getSharedConfig();
    if (shared){
      const list = parseList(shared.text);
      if (list.length){
        show(testView);
        startTest(list, shared.mode, shared.cMode);
      } else {
        show(teacherView);
        wordsBox.focus();
      }
    } else {
      show(teacherView);
      wordsBox.focus();
    }
  </script>
</body>
</html>
