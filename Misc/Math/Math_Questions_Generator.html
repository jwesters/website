<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Math Practice Generator (Export PDFs)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    .topbar { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .spacer { flex: 1; }
    .name { text-align: right; min-width: 360px; margin-top: 8px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin-top: 16px; }
    h1 { margin: 8px 0 0; font-size: 24px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px 48px; margin-top: 18px; }
    .q { font-size: 20px; line-height: 1.6; }
    label { font-weight: 600; }
    select, button { padding: 8px 10px; font-size: 14px; }
    button { cursor: pointer; }
    .muted { color: #666; font-size: 13px; margin-top: 6px; }
    .err { color: #b00; font-size: 13px; margin-top: 8px; }

    @media print {
      .topbar, .muted, .err { display: none !important; }
      body { margin: 0.5in; }
      .card { border: none; padding: 0; }
      .q { font-size: 18px; }
    }
  </style>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>

<div class="topbar">
  <label for="mode">Operation:</label>
  <select id="mode">
    <option value="add">Addition (+)</option>
    <option value="sub">Subtraction (−)</option>
    <option value="mul">Multiplication (×)</option>
    <option value="div">Division (÷)</option>
  </select>

  <label for="group">Group:</label>
  <select id="group"></select>

  <label for="count">Questions:</label>
  <select id="count">
    <option value="10">10</option>
    <option value="15">15</option>
    <option value="20">20</option>
  </select>

  <button id="generate">Generate</button>
  <button id="exportPdf">Export THIS page PDF</button>
  <button id="exportAllPdf">Export ALL 5 group pages PDF</button>
  <button onclick="window.print()">Print</button>

  <div class="spacer"></div>
</div>

<div class="name"><strong>Name:</strong> _______________________________</div>

<div class="card">
  <h1 id="title"></h1>
  <div class="muted" id="rules"></div>
  <div class="grid" id="questions"></div>
  <div class="err" id="err"></div>
</div>

<script>
  // ================= CONFIG =================
  const OTHER_MIN = 0;
  const OTHER_MAX = 10;

  // Subtraction rule: if subtracting by 7+, minuend can go up to 15
  const MINUEND_MAX_NORMAL = 10;
  const MINUEND_MAX_HIGH = 15;
  const HIGH_THRESHOLD = 7;

  // Division: ensure no remainder; exclude divisor 0
  // For divisor 7+, allow quotient up to 15 for more variety
  const DIV_QUOT_MAX_NORMAL = 10;
  const DIV_QUOT_MAX_HIGH = 15;

  const GROUPS = [
    { label: "0–2", values: [0,1,2] },
    { label: "3–4", values: [3,4] },
    { label: "5–6", values: [5,6] },
    { label: "7–8", values: [7,8] },
    { label: "9–10", values: [9,10] },
    { label: "All (0–10)", values: [0,1,2,3,4,5,6,7,8,9,10] }
  ];

  // For "Export ALL 5 group pages", we only want the 5 grouped pages (not "All")
  const FIVE_GROUP_INDICES = [0,1,2,3,4];

  // ================= UI =================
  const modeEl = document.getElementById("mode");
  const groupEl = document.getElementById("group");
  const countEl = document.getElementById("count");
  const titleEl = document.getElementById("title");
  const rulesEl = document.getElementById("rules");
  const qEl = document.getElementById("questions");
  const errEl = document.getElementById("err");

  let lastRendered = {
    mode: "add",
    groupLabel: "0–2",
    questions: [],
    count: 10
  };

  function fillGroups() {
    groupEl.innerHTML = "";
    GROUPS.forEach((g, i) => {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = g.label;
      groupEl.appendChild(opt);
    });
  }

  // ================= HELPERS =================
  const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

  function labelsFor(n) {
    // a..t for up to 20
    const letters = [];
    for (let i = 0; i < n; i++) letters.push(String.fromCharCode(97 + i));
    return letters;
  }

  // IMPORTANT CHANGE:
  // Key is ORDERED now, so 3+5 and 5+3 are treated as DIFFERENT and both allowed.
  // Still prevents exact duplicates in the same order.
  const orderedKey = (a, b) => `${a},${b}`;

  // ================= QUESTION GENERATION =================
  function makeAddQuestion(groupVals) {
    const addend = groupVals[randInt(0, groupVals.length - 1)];
    const other = randInt(OTHER_MIN, OTHER_MAX);
    const flip = Math.random() < 0.5;
    const a = flip ? other : addend;
    const b = flip ? addend : other;
    return { text: `${a} + ${b} =`, key: orderedKey(a, b) };
  }

  function makeMulQuestion(groupVals) {
    const factor = groupVals[randInt(0, groupVals.length - 1)];
    const other = randInt(OTHER_MIN, OTHER_MAX);
    const flip = Math.random() < 0.5;
    const a = flip ? other : factor;
    const b = flip ? factor : other;
    return { text: `${a} × ${b} =`, key: orderedKey(a, b) };
  }

  function makeSubQuestion(groupVals) {
    const sub = groupVals[randInt(0, groupVals.length - 1)];
    const maxMinuend = (sub >= HIGH_THRESHOLD) ? MINUEND_MAX_HIGH : MINUEND_MAX_NORMAL;
    const minuend = randInt(sub, maxMinuend); // ensures no negatives
    return { text: `${minuend} − ${sub} =`, key: orderedKey(minuend, sub) };
  }

  function makeDivQuestion(groupVals) {
    const divisor = groupVals[randInt(0, groupVals.length - 1)];
    if (divisor === 0) return null; // never allow divide by 0

    const qMax = (divisor >= HIGH_THRESHOLD) ? DIV_QUOT_MAX_HIGH : DIV_QUOT_MAX_NORMAL;
    const quotient = randInt(0, qMax);
    const dividend = divisor * quotient; // always remainder-free

    return { text: `${dividend} ÷ ${divisor} =`, key: orderedKey(dividend, divisor) };
  }

  function generateQuestions(mode, groupVals, count) {
    const seen = new Set();
    const out = [];
    let attempts = 0;

    while (out.length < count) {
      attempts++;
      if (attempts > 30000) throw new Error("Unable to generate enough unique questions for these settings.");

      let q = null;
      if (mode === "add") q = makeAddQuestion(groupVals);
      else if (mode === "sub") q = makeSubQuestion(groupVals);
      else if (mode === "mul") q = makeMulQuestion(groupVals);
      else if (mode === "div") q = makeDivQuestion(groupVals);

      if (!q) continue;

      if (seen.has(q.key)) continue; // prevents exact duplicates only (same order)
      seen.add(q.key);
      out.push(q.text);
    }
    return out;
  }

  // ================= RENDER =================
  function getOpName(mode) {
    return { add: "Adding", sub: "Subtracting", mul: "Multiplying", div: "Dividing" }[mode] || "Math";
  }

  function setRules(mode) {
    if (mode === "add") {
      rulesEl.textContent = "Duplicates ARE allowed if the order is different (3+5 and 5+3 can both appear). Numbers 0–10.";
    } else if (mode === "mul") {
      rulesEl.textContent = "Duplicates ARE allowed if the order is different (3×5 and 5×3 can both appear). Numbers 0–10.";
    } else if (mode === "sub") {
      rulesEl.textContent = "No negatives. If subtracting by 7 or higher, the minuend may go up to 15.";
    } else {
      rulesEl.textContent = "No remainders. Division by 0 is excluded automatically.";
    }
  }

  function render() {
    errEl.textContent = "";

    const mode = modeEl.value;
    const group = GROUPS[parseInt(groupEl.value, 10)];
    const count = parseInt(countEl.value, 10);

    titleEl.textContent = `${getOpName(mode)} ${group.label}`;
    setRules(mode);

    let qs;
    try {
      qs = generateQuestions(mode, group.values, count);
    } catch (e) {
      errEl.textContent = e.message;
      return;
    }

    lastRendered = { mode, groupLabel: group.label, questions: qs, count };

    qEl.innerHTML = "";
    const labels = labelsFor(count);

    qs.forEach((q, i) => {
      const div = document.createElement("div");
      div.className = "q";
      div.textContent = `${labels[i]}. ${q}`;
      qEl.appendChild(div);
    });
  }

  
  // ================= PDF EXPORT (jsPDF) =================
  function pdfSafeText(s) {
    // jsPDF default fonts don't reliably render some Unicode operators.
    // Convert them to ASCII equivalents just for PDF output.
    return String(s)
      .replace(/−/g, "-")
      .replace(/×/g, "x")
      .replace(/÷/g, "/");
  }

  function pdfDrawPage(doc, { mode, groupLabel, questions, count }, isFirstPage=false) {
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const margin = 54; // ~0.75"
    const colGap = 32;
    const colW = (pageW - margin * 2 - colGap) / 2;

    // Header line (Name)
    doc.setFont("helvetica", "normal");
    doc.setFontSize(12);
    doc.text("Name: _______________________________", pageW - margin, margin - 10, { align: "right" });

    // Title
    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text(`${getOpName(mode)} ${groupLabel}`, margin, margin + 22);

    // Questions (two columns)
    doc.setFont("helvetica", "normal");
    let fontSize = 14;
    let lineH = 22;
    if (count === 20) { fontSize = 13; lineH = 20; }
    doc.setFontSize(fontSize);

    const labels = labelsFor(count);
    const lines = questions.map((q, i) => `${labels[i]}. ${q}`);

    const leftCount = Math.ceil(lines.length / 2);
    const left = lines.slice(0, leftCount);
    const right = lines.slice(leftCount);

    const xLeft = margin;
    const xRight = margin + colW + colGap;
    const yStart = margin + 60;

    function drawColumn(colLines, x) {
      let y = yStart;
      for (const line of colLines) {
        if (y > pageH - margin) break;
        doc.text(pdfSafeText(line), x, y, { maxWidth: colW });
        y += lineH;
      }
    }

    drawColumn(left, xLeft);
    drawColumn(right, xRight);
  }

  function exportThisPagePdf() {
    errEl.textContent = "";
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) {
      errEl.textContent = "PDF library failed to load. Try Print → Save as PDF instead.";
      return;
    }

    const doc = new jsPDF({ unit: "pt", format: "letter" });
    pdfDrawPage(doc, lastRendered, true);

    const safeTitle = `${getOpName(lastRendered.mode)}_${lastRendered.groupLabel}`.replace(/[^\w\-]+/g, "_");
    doc.save(`${safeTitle}_${lastRendered.count}q.pdf`);
  }

  function exportAllFiveGroupsPdf() {
    errEl.textContent = "";
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) {
      errEl.textContent = "PDF library failed to load. Try Print → Save as PDF instead.";
      return;
    }

    const mode = modeEl.value;
    const count = parseInt(countEl.value, 10);

    const doc = new jsPDF({ unit: "pt", format: "letter" });

    FIVE_GROUP_INDICES.forEach((idx, i) => {
      const group = GROUPS[idx];
      const questions = generateQuestions(mode, group.values, count);

      if (i > 0) doc.addPage();
      pdfDrawPage(doc, { mode, groupLabel: group.label, questions, count }, i === 0);
    });

    const safeTitle = `${getOpName(mode)}_ALL_5_GROUPS`.replace(/[^\w\-]+/g, "_");
    doc.save(`${safeTitle}_${count}q.pdf`);
  }

  // ================= INIT =================
  fillGroups();
  groupEl.value = "0";
  render();

  document.getElementById("generate").addEventListener("click", render);
  document.getElementById("exportPdf").addEventListener("click", exportThisPagePdf);
  document.getElementById("exportAllPdf").addEventListener("click", exportAllFiveGroupsPdf);

  modeEl.addEventListener("change", render);
  groupEl.addEventListener("change", render);
  countEl.addEventListener("change", render);
</script>

</body>
</html>
