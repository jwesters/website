<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Word Scrambler Worksheet</title>
<style>
  :root{
    --bg:#0f1226;
    --text:#eef1ff;
    --muted:#b8bfe6;
    --accent:#7aa2ff;
    --good:#6bffb1;
    --bad:#ff6b6b;
    --border:rgba(255,255,255,.12);
    --shadow: 0 12px 30px rgba(0,0,0,.38);
    --radius:18px;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    background: radial-gradient(1000px 600px at 20% 10%, #1a1f4a 0%, rgba(26,31,74,0) 60%),
                radial-gradient(1000px 600px at 80% 0%, #2a1a4a 0%, rgba(42,26,74,0) 55%),
                linear-gradient(180deg, #0b0d1d 0%, #0f1226 60%, #0b0d1d 100%);
    color:var(--text);
  }
  .wrap{ max-width: 980px; margin: 0 auto; padding: 22px 16px 40px; }
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  header{
    padding: 18px 18px 14px;
    border-bottom: 1px solid var(--border);
    display:flex;
    gap:12px;
    align-items:flex-start;
    justify-content: space-between;
    flex-wrap: wrap;
  }
  header h1{ margin:0; font-size: 20px; letter-spacing:.2px; }
  header p{ margin:6px 0 0; color:var(--muted); font-size: 13px; line-height:1.35; max-width: 70ch; }
  .badge{
    font-size: 12px;
    color: var(--muted);
    padding: 8px 10px;
    border:1px solid var(--border);
    border-radius: 999px;
    background: rgba(0,0,0,.15);
    white-space: nowrap;
    user-select:none;
  }
  .content{ padding: 18px; }
  .grid{ display:grid; grid-template-columns: 1fr; gap: 14px; }
  @media (min-width: 860px){ .grid.two{ grid-template-columns: 1fr 1fr; } }
  .panel{
    background: rgba(0,0,0,.20);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 14px;
  }
  .panel h2{ margin:0 0 10px; font-size: 15px; letter-spacing:.2px; }
  .panel p{ margin: 0 0 18px; color: var(--muted); font-size: 13px; line-height: 1.35; }
  textarea{
    width:100%;
    min-height: 160px;
    resize: vertical;
    border-radius: 12px;
    border: 1px solid var(--border);
    padding: 10px 10px;
    background: rgba(10,12,28,.55);
    color: var(--text);
    outline: none;
    font-size: 14px;
    line-height: 1.35;
  }
  textarea:focus{ border-color: rgba(122,162,255,.65); box-shadow: 0 0 0 3px rgba(122,162,255,.16); }
  .row{
    display:flex;
    gap:10px;
    flex-wrap: wrap;
    align-items:center;
    justify-content: space-between;
  }
  .row .tight{ flex: 0 0 auto; }
  .btns{ display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
  button{
    border: 1px solid var(--border);
    background: rgba(255,255,255,.06);
    color: var(--text);
    border-radius: 12px;
    padding: 10px 12px;
    font-size: 14px;
    cursor:pointer;
    user-select:none;
    transition: transform .02s ease, background .15s ease, border-color .15s ease;
  }
  button:hover{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.20); }
  button:active{ transform: translateY(1px); }
  button.primary{ background: rgba(122,162,255,.20); border-color: rgba(122,162,255,.45); }
  button.primary:hover{ background: rgba(122,162,255,.27); }
  button.good{ background: rgba(107,255,177,.16); border-color: rgba(107,255,177,.35); }
  button.good:hover{ background: rgba(107,255,177,.22); }
  button.bad{ background: rgba(255,107,107,.14); border-color: rgba(255,107,107,.32); }
  button.bad:hover{ background: rgba(255,107,107,.20); }
  button:disabled{ opacity:.55; cursor:not-allowed; }
  .hint{ font-size: 12px; color: var(--muted); margin-top: 10px; line-height: 1.3; }
  .list{ display:grid; grid-template-columns: 1fr; gap: 10px; }
  .item{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    align-items:center;
    padding: 10px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: rgba(0,0,0,.16);
  }
  @media (max-width: 520px){ .item{ grid-template-columns: 1fr; } }
  .scr{ font-weight: 700; letter-spacing: .5px; font-size: 15px; }
  .scr small{
    display:block;
    font-weight: 600;
    letter-spacing: 0;
    color: var(--muted);
    font-size: 12px;
    margin-bottom: 2px;
  }
  .ansWrap{ display:flex; gap:8px; align-items:center; }
  .ans{
    width:100%;
    border-radius: 12px;
    border: 1px solid var(--border);
    padding: 10px 10px;
    background: rgba(10,12,28,.55);
    color: var(--text);
    outline:none;
    font-size: 14px;
  }
  .ans:focus{ border-color: rgba(122,162,255,.65); box-shadow: 0 0 0 3px rgba(122,162,255,.16); }
  .mark{
    width: 34px; height: 34px;
    display:grid; place-items:center;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.04);
    font-weight: 800;
    user-select:none;
    flex: 0 0 auto;
  }
  .mark.good{ border-color: rgba(107,255,177,.45); background: rgba(107,255,177,.14); color: var(--good); }
  .mark.bad{ border-color: rgba(255,107,107,.45); background: rgba(255,107,107,.14); color: var(--bad); }
  .status{ margin-top: 10px; color: var(--muted); font-size: 13px; line-height:1.35; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .small{ font-size:12px; color: var(--muted); }
  .hr{ height:1px; background: var(--border); margin: 12px 0; }
  .hidden{ display:none !important; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <div>
        <h1>Word Scrambler Worksheet</h1>
        <p id="subtitle">Loadingâ€¦</p>
      </div>
      <div class="badge" id="modeBadge">Mode: â€¦</div>
    </header>

    <div class="content">
      <!-- TEACHER -->
      <div id="teacherUI" class="grid two hidden">
        <div class="panel">
          <h2>Word list (max 16)</h2>
          <p>Enter one per line. Phrases are allowed (e.g., <span class="mono">ice cream</span>). Each word in a phrase is scrambled separately.</p>
          <textarea id="wordsTA" spellcheck="false" placeholder="cat&#10;because&#10;ice cream&#10;..."></textarea>

          <!-- Clear button directly under entry box -->
          <div class="btns" style="margin-top:10px;">
            <button id="btnClear" class="bad">Clear</button>
          </div>

          <div class="row" style="margin-top:12px;">
            <div class="btns">
              <button id="btnMakeLink" class="primary">Create student share link</button>
              <button id="btnCopyLink">Copy link</button>
            </div>
          </div>

          <div class="hint">Share links store the word list in the URL (simple obfuscation).</div>

          <div class="hr"></div>
          <div class="btns">
            <button id="btnExportPDF" class="good">Download PDF worksheet</button>
            <button id="btnExportKeyPDF" class="good">Download PDF answer key only</button>
          </div>
          <div class="status" id="teacherStatus"></div>
        </div>

        <div class="panel">
          <h2>Preview</h2>
          <p>This preview matches the student page (no teacher controls).</p>
          <div id="previewList" class="list" style="margin-top:12px;"></div>
          <div class="status" id="previewStatus"></div>
        </div>
      </div>

      <!-- STUDENT -->
      <div id="studentUI" class="grid hidden">
        <div class="panel">
          <h2>Unscramble the words</h2>
          <p>Type the correct word beside each scrambled one. When youâ€™re ready, click <b>Check Answers</b>.</p>
          <div id="studentList" class="list" style="margin-top:12px;"></div>
          <div class="row" style="margin-top:24px;">
            <div class="btns">
              <button id="btnCheck" class="primary">Check Answers</button>
              <button id="btnReset" class="bad">Reset</button>
            </div>
            <div class="tight small" id="scoreBox"></div>
          </div>
          <div class="status" id="studentStatus"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
"use strict";
const $ = id => document.getElementById(id);

/* === Scramble === */
function hash32(str){
  let h = 2166136261 >>> 0;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h>>>0;
}
function prng(seed){
  let x = seed>>>0;
  return ()=>{
    x ^= x<<13; x>>>=0;
    x ^= x>>>17; x>>>=0;
    x ^= x<<5; x>>>=0;
    return (x>>>0)/4294967296;
  };
}
function shuffle(arr, rnd){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(rnd()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function scrambleWordStable(word, seed){
  const chars=[...word];
  const idx=[], pool=[];
  for(let i=0;i<chars.length;i++){
    if(/[A-Za-z0-9]/.test(chars[i])){ idx.push(i); pool.push(chars[i]); }
  }
  if(pool.length<=1) return word;
  let rnd = prng(hash32(word.toLowerCase()) ^ seed);
  let sh = shuffle(pool.slice(), rnd);
  if(sh.join("")===pool.join("")) sh = pool.slice().reverse();
  for(let k=0;k<idx.length;k++) chars[idx[k]] = sh[k];
  return chars.join("");
}
function scramblePhraseStable(phrase, seed){
  return phrase.split(/(\s+)/).map(t=>/^\s+$/.test(t)?t:scrambleWordStable(t,seed)).join("");
}
function packWords(lines){
  return lines.map(l=>l.trim()).filter(Boolean).slice(0,16);
}
function normalizeAnswer(s){
  return String(s||"").toLowerCase().replace(/[\s\-]+/g,"").replace(/[â€™']/g,"");
}

/* === Share token (simple obfuscation) === */
function encode(words, seed){
  const obj = {w:words, s:seed};
  return btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
}
function decode(tok){
  return JSON.parse(decodeURIComponent(escape(atob(tok))));
}

/* === PDF (offline minimal PDF writer) === */
function escPdf(s){
  return String(s).replace(/\\/g,"\\\\").replace(/\(/g,"\\(").replace(/\)/g,"\\)");
}
function makePdf(pages){
  const objects=[];
  const add=o=>{objects.push(o); return objects.length;};
  const fontObj = add("<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica >>");
  const contentObjs = pages.map(p=> add(`<< /Length ${new TextEncoder().encode(p).length} >>\nstream\n${p}\nendstream`));
  const pageObjs = contentObjs.map(c=> add(`<< /Type /Page /Parent 0 0 R /MediaBox [0 0 612 792] /Resources << /Font << /F1 ${fontObj} 0 R >> >> /Contents ${c} 0 R >>`));
  const kids = pageObjs.map(n=>`${n} 0 R`).join(" ");
  const pagesObj = add(`<< /Type /Pages /Count ${pageObjs.length} /Kids [ ${kids} ] >>`);
  pageObjs.forEach((_,i)=>{ objects[pageObjs[i]-1]=objects[pageObjs[i]-1].replace("/Parent 0 0 R", `/Parent ${pagesObj} 0 R`); });
  const catObj = add(`<< /Type /Catalog /Pages ${pagesObj} 0 R >>`);

  let out="%PDF-1.4\n";
  const offs=[0];
  for(let i=0;i<objects.length;i++){
    offs.push(out.length);
    out += `${i+1} 0 obj\n${objects[i]}\nendobj\n`;
  }
  const xrefPos = out.length;
  out += `xref\n0 ${objects.length+1}\n0000000000 65535 f \n`;
  for(let i=1;i<offs.length;i++) out += String(offs[i]).padStart(10,"0")+" 00000 n \n";
  out += `trailer\n<< /Size ${objects.length+1} /Root ${catObj} 0 R >>\nstartxref\n${xrefPos}\n%%EOF`;
  return new Blob([out], {type:"application/pdf"});
}

function buildWorksheetPDF(words, scrambled){
  // Dynamic spacing so content never overflows the page
  const leftX=54, rightX=318, topY=740;
  const startY=610;
  const bottomMargin = 80;
  const desiredLineGap = 110; // target spacing between items
  const desiredLineOffset = 70; // target distance from word to line

  const col1 = scrambled.slice(0,8);
  const col2 = scrambled.slice(8,16);
  const rows = Math.max(col1.length, col2.length, 1);

  const available = startY - bottomMargin;
  const lineGap = rows > 1 ? Math.min(desiredLineGap, Math.floor(available/(rows-1))) : desiredLineGap;
  const lineOffset = Math.min(desiredLineOffset, Math.floor(lineGap * 0.6));

  let ops="";
  ops += "0.9 w\n";
  ops += `BT /F1 18 Tf 1 0 0 1 54 ${topY} Tm (Word Scrambler) Tj ET\n`;
  ops += `BT /F1 11 Tf 1 0 0 1 54 ${topY-22} Tm (Unscramble each word.) Tj ET\n`;

  // Name/Date on worksheet only
  ops += `BT /F1 12 Tf 1 0 0 1 54 ${topY-52} Tm (Name:) Tj ET\n`;
  ops += `${98} ${topY-54} m ${300} ${topY-54} l S\n`;
  ops += `BT /F1 12 Tf 1 0 0 1 318 ${topY-52} Tm (Date:) Tj ET\n`;
  ops += `${355} ${topY-54} m ${558} ${topY-54} l S\n`;

  function draw(items, baseX, startIndex){
    for(let i=0;i<items.length;i++){
      const y = startY - i*lineGap;
      const n = startIndex+i+1;
      ops += `BT /F1 12 Tf 1 0 0 1 ${baseX} ${y} Tm (${escPdf(n + ") " + items[i])}) Tj ET\n`;
      ops += `${baseX} ${y-lineOffset} m ${baseX+240} ${y-lineOffset} l S\n`;
    }
  }
  draw(col1, leftX, 0);
  draw(col2, rightX, 8);
  return makePdf([ops]);
}
function buildKeyPDF(words){
  // NO Name/Date on answer key
  const leftX=54, rightX=318, topY=740;
  const startY=700, lineGap=44;

  let ops="";
  ops += "0.9 w\n";
  ops += `BT /F1 18 Tf 1 0 0 1 54 ${topY} Tm (Word Scrambler) Tj ET\n`;
  ops += `BT /F1 11 Tf 1 0 0 1 54 ${topY-22} Tm (Answer Key) Tj ET\n`;

  function draw(items, baseX, startIndex){
    for(let i=0;i<items.length;i++){
      const y = startY - i*lineGap;
      const n = startIndex+i+1;
      ops += `BT /F1 12 Tf 1 0 0 1 ${baseX} ${y} Tm (${escPdf(n + ") " + items[i])}) Tj ET\n`;
    }
  }
  draw(words.slice(0,8), leftX, 0);
  draw(words.slice(8,16), rightX, 8);
  return makePdf([ops]);
}
function download(blob, name){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=name;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href),1000);
}

/* === Render === */
function renderPreview(words, scrambled){
  const host = $("previewList"); host.innerHTML="";
  if(!words.length){
    $("previewStatus").textContent = "Enter words on the left to see a preview.";
    return;
  }
  $("previewStatus").textContent = `${words.length} item(s).`;
  scrambled.forEach((s,i)=>{
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML = `
      <div class="scr"><small>${i+1}.</small>${s}</div>
      <div class="ansWrap">
        <input class="ans" disabled placeholder="Student types answer here" />
        <div class="mark">â€¢</div>
      </div>`;
    host.appendChild(div);
  });
}

/* === Modes === */
function setMode(m){
  $("teacherUI").classList.toggle("hidden", m!=="teacher");
  $("studentUI").classList.toggle("hidden", m!=="student");
  $("modeBadge").textContent="Mode: "+(m==="teacher"?"Teacher":"Student");
  $("subtitle").textContent = m==="teacher"
    ? "Teacher: enter up to 16 words/phrases, generate a share link for students, and export worksheet PDFs (downloaded, not printed)."
    : "Student: unscramble the words and check your answers.";
}

function initTeacher(){
  setMode("teacher");
  const status=$("teacherStatus");

  function update(){
    const words = packWords($("wordsTA").value.split("\n"));
    const seed = hash32(words.join("\n").toLowerCase()) ^ 0xC0FFEE;
    const scrambled = words.map(w=>scramblePhraseStable(w, seed));
    renderPreview(words, scrambled);
    $("btnMakeLink").disabled = !words.length;
    $("btnExportPDF").disabled = !words.length;
    $("btnExportKeyPDF").disabled = !words.length;
    return {words, seed, scrambled};
  }

  $("wordsTA").addEventListener("input", ()=>{ update(); status.textContent=""; });
  $("btnClear").onclick=()=>{ $("wordsTA").value=""; update(); status.textContent="Cleared."; };

  let lastLink="";
  $("btnMakeLink").onclick=()=>{
    const {words, seed} = update();
    if(!words.length){ status.textContent="Enter at least one word."; return; }
    const tok = encode(words, seed);
    lastLink = location.href.split("#")[0] + "#d=" + tok;
    status.textContent="Share link created. Use Copy link.";
  };
  $("btnCopyLink").onclick=async()=>{
    if(!lastLink){ status.textContent="Create the link first."; return; }
    try{ await navigator.clipboard.writeText(lastLink); status.textContent="Copied!"; }
    catch{
      // fallback: show link in status for manual copy
      status.textContent = "Copy failed. Link: " + lastLink;
    }
  };

  $("btnExportPDF").onclick=()=>{
    const {words, scrambled} = update();
    if(!words.length){ status.textContent="Enter at least one word."; return; }
    download(buildWorksheetPDF(words, scrambled), "word_scrambler_worksheet.pdf");
    status.textContent="Downloaded worksheet PDF.";
  };
  $("btnExportKeyPDF").onclick=()=>{
    const {words} = update();
    if(!words.length){ status.textContent="Enter at least one word."; return; }
    download(buildKeyPDF(words), "word_scrambler_answer_key.pdf");
    status.textContent="Downloaded answer key PDF.";
  };

  update();
}

function initStudent(tok){
  setMode("student");
  const status=$("studentStatus"), scoreBox=$("scoreBox");

  let data;
  try{ data = decode(tok); }
  catch{ status.textContent="Invalid link."; return; }

  const words = Array.isArray(data.w)?data.w.slice(0,16):[];
  const seed = (data.s>>>0) || (hash32(words.join("\n").toLowerCase()) ^ 0xC0FFEE);
  const scrambled = words.map(w=>scramblePhraseStable(w, seed));

  const host=$("studentList"); host.innerHTML="";
  if(!words.length){
    status.textContent="No words found in this link.";
    return;
  }

  scrambled.forEach((s,i)=>{
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML = `
      <div class="scr"><small>${i+1}.</small>${s}</div>
      <div class="ansWrap">
        <input class="ans" autocomplete="off" autocapitalize="none" spellcheck="false" placeholder="Type the word" />
        <div class="mark" id="m_${i}">â€¢</div>
      </div>`;
    host.appendChild(d);
  });

  scoreBox.textContent=`0 / ${words.length}`;

  function setMark(i, kind){
    const m = $("m_"+i);
    m.classList.remove("good","bad");
    if(kind==="good"){ m.textContent="âœ“"; m.classList.add("good"); }
    else if(kind==="bad"){ m.textContent="âœ•"; m.classList.add("bad"); }
    else { m.textContent="â€¢"; }
  }

  $("btnReset").onclick=()=>{
    host.querySelectorAll(".ans").forEach(inp=>inp.value="");
    for(let i=0;i<words.length;i++) setMark(i,null);
    scoreBox.textContent=`0 / ${words.length}`;
    status.textContent="Reset.";
  };

  $("btnCheck").onclick=()=>{
    const ins=[...host.querySelectorAll(".ans")];
    let ok=0;
    for(let i=0;i<words.length;i++){
      const good = normalizeAnswer(ins[i].value) === normalizeAnswer(words[i]);
      if(good){ ok++; setMark(i,"good"); }
      else setMark(i,"bad");
    }
    scoreBox.textContent=`${ok} / ${words.length}`;
    status.textContent = ok===words.length ? "Perfect! ðŸŽ‰" : "Checked.";
  };

  status.textContent = "Type your answers, then click Check Answers.";
}

/* === Boot === */
(function boot(){
  const h=(location.hash||"").replace(/^#/,"");
  const p=new URLSearchParams(h);
  const tok=p.get("d");
  if(tok) initStudent(tok);
  else initTeacher();
})();
</script>
</body>
</html>
